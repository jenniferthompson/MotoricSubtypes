---
title: Motoric Delirium Subtypes vs Discharge & Long-Term Outcomes
author: 'Jennifer Thompson, MPH; Supervisor: Rameela Chandrasekhar, PhD'
date: '`r format(Sys.time(), "%B %d %Y")`'
output:
  html_notebook:
    code_folding: hide
    toc: yes
    toc_depth: 4
    toc_float: yes
  html_document:
    toc: yes
    toc_depth: 2
    toc_float: yes
  pdf_document:
    toc: yes
    toc_depth: 2
abstract: We describe the prevalence of both hypoactive and hyperactive delirium in the BRAIN-ICU
  cohort, then investigate the association of both of these motoric subtypes with discharge location,
  mortality, and long-term cognition.
---

```{r knitr_setup, echo = FALSE, message = FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, results='hide')
options(width = 200)
```

```{r general_setup, results='hide'}
library(tidyverse)
library(pander)
library(rms)
library(mice)

options(grType = 'plotly')

## Spacing for pandoc tables
space.3 <- paste(rep("&nbsp;", 3), collapse = '')
space.6 <- paste(rep("&nbsp;", 6), collapse = '')

## -- Set up figure, table numbering using the captioner package -----------------------------------
library(captioner)
table_nums <- captioner(prefix = 'Table')
figure_nums <- captioner(prefix = 'Figure')

table_nums(name = 'screentable', caption = 'Screening and Enrollment')
table_nums(name = 'exctable', caption = 'Exclusions')
table_nums(name = 'consorttable', caption = 'Patient Status Over Time')
table_nums(name = 'describe_byasmt', caption = 'Status and Motoric Subtypes by Assessment')
table_nums(name = 'describe_byday', caption = 'Status and Motoric Subtypes by Patient-Day')
table_nums(name = 'describe_bypt', caption = 'Status and Motoric Subtypes by Patient')

# figure_nums(name = 'describe_bypt', caption = 'Status and Motoric Subtypes by Patient')

```

```{r combinedata}
## -- Source script which either combines BRAIN+MINDICU data, or sets up BRAIN data, ---------------
## -- depending on operating system; creates "all.xxxxx" data sets to use in rest of analysis ------

## If working with VA data
if(Sys.info()['sysname'] == 'Windows'){
  source('combine_brainmind_datasets.R')
## If using only BRAIN data  
} else{
  ## Home directory (if on Mac, assumes connected to desktop via Samba)
  if(Sys.info()['sysname'] == 'Darwin'){
    home.dir <- '/Volumes'
  } else{
    home.dir <- '/home'
  }
  source(file.path(home.dir, 'thomps23', 'ICUDelirium', 'BRAINICU', 'combine_brainmind_datasets.R'))
}

```

# Description of Cohort
## Screening, Exclusions, Enrollment, and Patient Status
`r table_nums('screentable', display = 'cite')` shows the number of patients screened, enrolled and
excluded in the entire cohort; `r table_nums('exctable', display = 'cite')` presents the reasons for exclusion. `r table_nums('consorttable', display = 'cite')` shows the status of each patient over
both the in-hospital and followup periods.

```{r consortinfo}
## -- Determine whether patients had at least partial followup at each time point ------------------
cog.outcomes <- c('rbans.global.score', 'rbans.immmemory.tscore', 'rbans.delayedmem.tscore',
                  'rbans.visuo.tscore', 'rbans.attention.tscore', 'rbans.language.tscore',
                  'trail.b.tscore', 'mmse.tscore')

all.fu$n.cog.tests <- rowSums(!is.na(all.fu[,cog.outcomes]))
all.fu$cog.test.status <- with(all.fu, factor(ifelse(n.cog.tests == 0, 1,
                                              ifelse(n.cog.tests == length(cog.outcomes), 3, 2)),
                                              levels = 1:3,
                                              labels = c('No cognitive data',
                                                         'Partial cognitive data',
                                                         'Complete cognitive data')))

followup.status <- all.fu %>%
  filter(fu.period %in% c('3 Month', '12 Month')) %>%
  select(id, fu.period, status, cog.test.status, one_of(cog.outcomes)) %>%
  mutate(fu.period = gsub(' Month', '', fu.period)) %>%
  gather(key = var, value = varvalue, status:mmse.tscore) %>%
  unite(var.time, var, fu.period, sep = '.') %>%
  spread(key = var.time, value = varvalue)

## -- Create data frame of all screened patients, exclusion reasons, and status at each time -------
## -- point: enrollment, discharge, 3m, 12m --------------------------------------------------------
all.exc$id <- all.exc$ex.id

all.pts <- merge(subset(all.exc, select = c(id, exc.rsn.2)),
                 subset(all.oneobs, select = c(id, withdrew.data, studywd.amt, died.inhosp)),
                 by = 'id', all = TRUE) %>%
  left_join(select(followup.status, id, status.3, cog.test.status.3, status.12, cog.test.status.12),
            by = 'id') %>%
  mutate(## Status at enrollment: excluded, refused, or enrolled
         was.approached = is.na(exc.rsn.2) | exc.rsn.2 == 'Surrogate or patient refused consent',
         refused.consent = !is.na(exc.rsn.2) & exc.rsn.2 == 'Surrogate or patient refused consent',
         was.enrolled = is.na(exc.rsn.2),
         status.enroll = factor(ifelse(!was.approached, 1,
                                ifelse(refused.consent, 2, 3)),
                                levels = 1:3,
                                labels = c('Excluded', 'Refused', 'Enrolled')),
         ## Indicator for whether to be included in any analyses: enrolled and kept some data
         include.main = status.enroll == 'Enrolled' & !withdrew.data,
         ## Status at discharge: discharged alive, withdrew, died in hospital
         status.discharge = factor(ifelse(!was.enrolled | withdrew.data, NA,
                                   ifelse(died.inhosp == 'Died in hospital', 1,
                                   ifelse(!is.na(studywd.amt), 2, 3))),
                                   levels = 1:3,
                                   labels = c('Died in hospital',
                                              'Withdrew in hospital',
                                              'Discharged alive')),
         ## Indicator for whether to include in hospital survivors cohort: enrolled, survived
         ## hospital stay and still in study
         include.survivors = status.enroll == 'Enrolled' & !withdrew.data &
           status.discharge == 'Discharged alive',
         ## Status at 3 months: died between discharge and followup, withdrew between discharge
         ## and followup, permanently lost to followup, temporarily lost to followup, or tested
         status.3m = factor(ifelse(is.na(status.discharge) |
                                     status.discharge %in% c('Died in hospital',
                                                             'Withdrew in hospital'), NA,
                            ifelse(status.3 == 'Deceased', 1,
                            ifelse(status.3 == 'Living-Withdrew from the study', 2,
                            ifelse(cog.test.status.3 == 'No cognitive data' &
                                     (is.na(cog.test.status.12) |
                                        cog.test.status.12 == 'No cognitive data'), 3,
                            ifelse(cog.test.status.3 == 'No cognitive data', 4,
                            ifelse(cog.test.status.3 == 'Partial cognitive data', 5,
                            ifelse(cog.test.status.3 == 'Complete cognitive data', 6, NA))))))),
                            levels = 1:6,
                            labels = c('Died before 3m followup',
                                       'Withdrew before 3m followup',
                                       'Permanently lost to followup',
                                       'Temporarily lost to followup',
                                       'Partial cognitive testing',
                                       'Complete cognitive testing')),
         ## Include in main analysis at 3 months: if at least partial cognitive data
         include.3m = !is.na(status.3m) & status.3m %in%
           paste(c('Partial', 'Complete'), 'cognitive testing'),
         ## Status at 12 months: died between discharge and followup, withdrew between discharge
         ## and followup, lost to followup, or tested
         status.12m = factor(ifelse(is.na(status.3m) |
                                     status.3m %in% c('Died before 3m followup',
                                                      'Withdrew before 3m followup'), NA,
                            ifelse(status.12 == 'Deceased', 1,
                            ifelse(status.12 == 'Living-Withdrew from the study', 2,
                            ifelse(cog.test.status.12 == 'No cognitive data', 3,
                            ifelse(cog.test.status.12 == 'Partial cognitive data', 4,
                            ifelse(cog.test.status.12 == 'Complete cognitive data', 5, NA)))))),
                            levels = 1:5,
                            labels = c('Died before 12m followup',
                                       'Withdrew before 12m followup',
                                       'Lost to followup',
                                       'Partial cognitive testing',
                                       'Complete cognitive testing')),
         ## Include in main analysis at 12 months: if at least partial cognitive data
         include.12m = !is.na(status.12m) & status.12m %in%
           paste(c('Partial', 'Complete'), 'cognitive testing'))

## Create vectors of IDs of patients included in long-term analyses at either time point
ltpts.either <- subset(all.pts, include.3m | include.12m)$id
ltpts.3m <- subset(all.pts, include.3m)$id
ltpts.12m <- subset(all.pts, include.12m)$id

```

```{r screen_table}
## -- Table: Screening and enrollment --------------------------------------------------------------
## Assign numerators and denominators for each category
n.screened <- nrow(all.pts)
n.excluded <- sum(all.pts$status.enroll == 'Excluded')
d.excluded <- n.screened
n.approached <- sum(all.pts$was.approached)
d.approached <- n.screened
n.refused <- sum(all.pts$refused.consent)
d.refused <- n.approached
n.enrolled <- sum(all.pts$was.enrolled)
d.enrolled <- n.approached
n.withdrewdata <- sum(all.pts$withdrew.data, na.rm = TRUE)
d.withdrewdata <- n.enrolled
n.included <- sum(all.pts$include.main)
d.included <- n.enrolled

screen.table <- data.frame(spacing = c('', rep(space.3, 2), rep(space.6, 2),
                                       rep(paste0(space.3, space.6), 2)),
                           rowlabel = c('Screened', 'Excluded', 'Approached', 'Refused', 'Enrolled',
                                        'Withdrew all data', 'Included in analyses'),
                           npts = c(n.screened, n.excluded, n.approached, n.refused, n.enrolled,
                                    n.withdrewdata, n.included),
                           dpts = c(NA, d.excluded, d.approached, d.refused, d.enrolled,
                                    d.withdrewdata, d.included)) %>%
  mutate(pctpts = round((npts / dpts)*100),
         npct = ifelse(is.na(dpts), format(npts, big.mark = ','),
                       paste0(format(npts, big.mark = ','), ' (', pctpts, '%)')),
         final.rowlabel = ifelse(rowlabel == 'Included in analyses',
                                 paste0(spacing, '**', rowlabel, '**'),
                                 paste0(spacing, rowlabel))) %>%
  select(final.rowlabel, npct)

names(screen.table) <- c('', 'N (%)')

```


#### `r table_nums('screentable')`
```{r print_screentable, results = 'asis'}
pandoc.table(screen.table, justify = c('left', 'right'), split.cells = Inf, split.table = Inf)

```

#### `r table_nums('exctable')`
```{r exctable}
exc.ns <- all.exc %>%
  group_by(exc.rsn.2) %>%
  summarise(exc.n = n()) %>%
  filter(exc.rsn.2 != 'Surrogate or patient refused consent') %>%
  mutate(exc.pct = round((exc.n / n.excluded)*100),
         exc.npct = paste0(exc.pct, '% (', exc.n, ')')) %>%
  arrange(desc(exc.pct)) %>%
  select(exc.rsn.2, exc.npct)

names(exc.ns) <- c('Exclusion', '% (N)')

```
```{r print_exctable, results = 'asis'}
pandoc.table(exc.ns, justify = c('left', 'right'), split.cells = Inf, split.table = Inf)

```

```{r consort_table}
## -- Table: Enrolled patient status ---------------------------------------------------------------
## Assign numerators and denominators for each category
n.died.inhosp <- sum(all.pts$status.discharge == 'Died in hospital', na.rm = TRUE)
n.wd.inhosp <- sum(all.pts$status.discharge == 'Withdrew in hospital', na.rm = TRUE)
n.surv.inhosp <- sum(all.pts$status.discharge == 'Discharged alive', na.rm = TRUE)
d.died.inhosp <- d.wd.inhosp <- d.surv.inhosp <- n.included

lost.to.fu <- c('Permanently lost to followup', 'Temporarily lost to followup', 'Lost to followup')
elig.for.fu <- c(lost.to.fu, 'Partial cognitive testing', 'Complete cognitive testing')

n.died.3m <- sum(all.pts$status.3m == 'Died before 3m followup', na.rm = TRUE)
n.wd.3m <- sum(all.pts$status.3m == 'Withdrew before 3m followup', na.rm = TRUE)
n.elig.3m <- sum(all.pts$status.3m %in% elig.for.fu, na.rm = TRUE)
d.died.3m <- d.wd.3m <- d.elig.3m <- n.surv.inhosp

n.lost.3m <- sum(all.pts$status.3m %in% lost.to.fu, na.rm = TRUE)
n.permlost.3m <- sum(all.pts$status.3m == 'Permanently lost to followup', na.rm = TRUE)
n.templost.3m <- sum(all.pts$status.3m == 'Temporarily lost to followup', na.rm = TRUE)
n.inc.3m <- sum(all.pts$include.3m)
n.part.3m <- sum(all.pts$status.3m == 'Partial cognitive testing', na.rm = TRUE)
n.comp.3m <- sum(all.pts$status.3m == 'Complete cognitive testing', na.rm = TRUE)

d.lost.3m <- d.inc.3m <- n.elig.3m
d.permlost.3m <- d.templost.3m <- n.lost.3m
d.part.3m <- d.comp.3m <- n.inc.3m

n.died.12m <- sum(all.pts$status.12m == 'Died before 12m followup', na.rm = TRUE)
n.wd.12m <- sum(all.pts$status.12m == 'Withdrew before 12m followup', na.rm = TRUE)
n.elig.12m <- sum(all.pts$status.12m %in% elig.for.fu, na.rm = TRUE)
d.died.12m <- d.wd.12m <- d.elig.12m <- n.elig.3m

n.lost.12m <- sum(all.pts$status.12m %in% lost.to.fu, na.rm = TRUE)
n.inc.12m <- sum(all.pts$include.12m)
n.part.12m <- sum(all.pts$status.12m == 'Partial cognitive testing', na.rm = TRUE)
n.comp.12m <- sum(all.pts$status.12m == 'Complete cognitive testing', na.rm = TRUE)

d.lost.12m <- d.inc.12m <- n.elig.12m
d.part.12m <- d.comp.12m <- n.inc.12m

n.elig.either <- length(ltpts.either)
d.elig.either <- n.surv.inhosp

consort.table <- data.frame(spacing = c(rep('', 9),
                                        space.3, space.6, space.6,
                                        space.3, space.6, space.6, '',
                                        rep('', 3), space.3, space.3, space.6, space.6, '', ''),
                            rowlabel = c('Main cohort', '&nbsp;',
                                         'Died in hospital', 'Withdrew in hospital',
                                         'Discharged alive, remained in study', '&nbsp;',
                                         'Died before 3m followup', 'Withdrew before 3m followup',
                                         'Eligible for 3m outcomes',
                                         'Lost to followup', 'Permanently (no 12m data)',
                                         'Temporarily (had 12m data)',
                                         'Had 3m outcomes', 'Partial', 'Complete', '&nbsp;',
                                         'Died before 12m followup', 'Withdrew before 12m followup',
                                         'Eligible for 12m outcomes', 'Lost to followup',
                                         'Had 12m outcomes', 'Partial', 'Complete', '&nbsp;',
                                         'Eligible for LT outcomes analyses, either time point'),
                            npts = c(n.included, NA,
                                     n.died.inhosp, n.wd.inhosp, n.surv.inhosp, NA,
                                     n.died.3m, n.wd.3m, n.elig.3m,
                                     n.lost.3m, n.permlost.3m, n.templost.3m,
                                     n.inc.3m, n.part.3m, n.comp.3m, NA,
                                     n.died.12m, n.wd.12m, n.elig.12m, n.lost.12m,
                                     n.inc.12m, n.part.12m, n.comp.12m, NA, n.elig.either),
                            dpts = c(NA, NA,
                                     d.died.inhosp, d.wd.inhosp, d.surv.inhosp, NA,
                                     d.died.3m, d.wd.3m, d.elig.3m,
                                     d.lost.3m, d.permlost.3m, d.templost.3m,
                                     d.inc.3m, d.part.3m, d.comp.3m, NA,
                                     d.died.12m, d.wd.12m, d.elig.12m, d.lost.12m,
                                     d.inc.12m, d.part.12m, d.comp.12m, NA, d.elig.either)) %>%
  mutate(pctpts = round((npts / dpts)*100),
         npct = ifelse(is.na(npts), '',
                ifelse(is.na(pctpts), format(npts, big.mark = ','),
                       paste0(format(npts, big.mark = ','), ' (', pctpts, '%)'))),
         final.rowlabel = paste0(spacing, rowlabel)) %>%
  select(final.rowlabel, npct)

names(consort.table) <- c('', 'N (%)')

```

#### `r table_nums('consorttable')`
```{r print_consorttable, results = 'asis'}
pandoc.table(consort.table, justify = c('left', 'right'), split.cells = Inf, split.table = Inf)

```

# Primary Exposure: Motoric Subtypes of Delirium
Most of the variables included in these analyses have been documented or discussed elsewhere. The
exposure variables specific to this analysis are hypo- and hyperactive delirium, generally referred
to as motoric subtypes.

For any given CAM/RASS assessment, a patient was considered to have hypoactive delirium if he or she
was CAM+ and had a RASS <= 0. A patient was considered to have hyperactive delirium if he or she was
CAM+ but had a RASS > 0. A day could have both hypoactive and hyperactive delirium assessments, if
the patient was in the ICU and was delirious at both research staff assessments.

## Handling Missingness
If patient-day had no mental status assessment on an in-hospital study day, we originally used
single imputation to impute an overall status (normal, delirious or comatose), based on the status
on the days immediately prior to and after the missing day. If a missing study day was assigned a
normal or comatose status during single imputation, we assumed no hypoactive or hyperactive
delirium. For days which were assigned a delirious status, we imputed indicators for whether
delirium was hypoactive or hyperactive based on overall mental status, coma, and motoric subtypes on
the days immediately prior to and after the missing day.

```{r datamgmt_subtypes}
## -- Determine whether pt had hypoactive or hyperactive delirium at each single *assessment* ------
all.assess <- all.assess %>%
  left_join(select(all.daily, id, study.date, study.day),
            by = c('id' = 'id', 'asmt.date' = 'study.date')) %>%
  mutate(mental.stat.motoric = factor(ifelse(is.na(mental.stat), NA,
                                      ifelse(mental.stat == 'Normal', 1,
                                      ifelse(mental.stat == 'Delirious' &
                                               is.na(rass.daily) | !(rass.daily %in% -5:4), 2,
                                      ifelse(mental.stat == 'Delirious' & rass.daily <= 0, 3,
                                      ifelse(mental.stat == 'Delirious' & rass.daily > 0, 4,
                                      ifelse(mental.stat == 'Comatose', 5, NA)))))),
                                      levels = 1:5,
                                      labels = c('Normal', 'Delirium, no RASS',
                                                 'Hypoactive delirium', 'Hyperactive delirium',
                                                 'Coma')))

## -- Determine how much hypoactive/hyperactive delirium pt had on each study *day* ----------------
motoric.byday <- all.assess %>%
  group_by(id, study.day) %>%
  summarise(n.asmts = sum(!is.na(mental.stat.motoric)),
            normal.asmts = sum(mental.stat.motoric == 'Normal', na.rm = TRUE),
            hypo.del.asmts = sum(mental.stat.motoric == 'Hypoactive delirium', na.rm = TRUE),
            hyper.del.asmts = sum(mental.stat.motoric == 'Hyperactive delirium', na.rm = TRUE),
            coma.asmts = sum(mental.stat.motoric == 'Coma', na.rm = TRUE)) %>%
  mutate(mental.stat.subtype = factor(ifelse(n.asmts == 0, NA,
                                      ifelse(hypo.del.asmts > 0 & hyper.del.asmts > 0, 3,
                                      ifelse(hypo.del.asmts > 0, 4,
                                      ifelse(hyper.del.asmts > 0, 2,
                                      ifelse(coma.asmts > 0, 5,
                                      ifelse(normal.asmts > 0, 1, NA)))))),
                                      levels = 1:5,
                                      labels = c('No delirium or coma',
                                                 'Hyperactive delirium',
                                                 'Both hypo- and hyperactive delirium',
                                                 'Hypoactive delirium',
                                                 'No delirium; had coma')))

## Add daily subtypes back onto main daily data set
all.daily <- all.daily %>%
  left_join(select(motoric.byday, id, study.day, mental.stat.subtype),
            by = c('id', 'study.day'))

## -- Impute mental status incorporating subtypes for days with no assessment which were -----------
## -- assigned delirium in original single imputation ----------------------------------------------
subtype.impdata <- all.daily %>%
  select(id, study.day, mental.stat.imp, mental.stat.subtype, stat.before.imp, stat.after.imp,
         coma.today) %>%
  group_by(id) %>%
  ## Create variables for mental status + subtypes, coma yesterday and tomorrow
  mutate(mental.subtype.yday = lag(mental.stat.subtype),
         mental.subtype.tmw = lead(mental.stat.subtype),
         coma.yday = lag(coma.today),
         coma.tmw = lead(coma.today),
         ## Initialize imputed version of mental status + subtypes, incorporating normal/coma
         ## imputation from original data set
         del.subtype = factor(ifelse(!is.na(mental.stat.subtype), as.character(mental.stat.subtype),
                                     NA))) %>%
  ungroup() %>%
  ## Restrict to only delirium days; otherwise delirium days might get imputed as normal or coma
  filter(mental.stat.imp == 'Delirious') %>%
  ## Some variables need to be refactored - original factor levels (Deceased, Discharged,
  ## Withdrawn) don't show up in this data set and cause errors in imputation
  select(-mental.stat.subtype, -mental.stat.imp) %>%
  mutate(stat.before.imp = factor(as.character(stat.before.imp)),
         coma.today = factor(as.character(coma.today)),
         coma.yday = factor(as.character(coma.yday)),
         coma.tmw = factor(as.character(coma.tmw)),
         del.subtype = factor(as.character(del.subtype)))

## predictorMatrix for mice(): uses all covariates except ID for motoric subtype variable, none
## for all others
impdata.cols <- ncol(subtype.impdata)
subtype.predmatrix <- matrix(c(rep(0, impdata.cols*(impdata.cols - 1)),
                               c(0, rep(1, impdata.cols - 1))),
                             byrow = TRUE, ncol = impdata.cols)

## Perform single imputation (only one imputation) and get complete data set
subtype.mice <- mice(subtype.impdata, m = 1, predictorMatrix = subtype.predmatrix, seed = 56)
subtype.mice.complete <- complete(subtype.mice)

## Create final version of imputed mental status + subtype, and create indicators for whether
## patient had hypoactive and hyperactive delirium each day
all.daily <- all.daily %>%
  left_join(select(subtype.mice.complete, id, study.day, del.subtype),
            by = c('id', 'study.day')) %>%
  mutate(## Indicator for whether patient was on sedation (benzodiazepines and/or propofol)
         on.sedation = ifelse(is.na(mental.stat.imp), NA,
                              ((!is.na(tot.benz) & tot.benz > 0) |
                                 (!is.na(tot.prop) & tot.prop > 0))),
         mental.stat.subtype.imp =
           factor(ifelse(is.na(mental.stat.imp), NA,
                  ifelse(mental.stat.imp == 'Normal', 1,
                  ifelse(mental.stat.imp == 'Comatose', 5,
                  ifelse(!is.na(del.subtype) & del.subtype == 'Hyperactive delirium', 2,
                  ifelse(!is.na(del.subtype) & del.subtype == 'Both hypo- and hyperactive delirium',
                         3,
                  ifelse(!is.na(del.subtype) & del.subtype == 'Hypoactive delirium', 4, NA)))))),
                  levels = 1:5,
                  labels = levels(all.daily$mental.stat.subtype)),
         hypo.del.today = factor(ifelse(is.na(mental.stat.subtype), NA,
                                 ifelse(mental.stat.subtype %in%
                                          c('Both hypo- and hyperactive delirium',
                                            'Hypoactive delirium'), 1, 0)),
                                 levels = 0:1, labels = c('No', 'Yes')),
         hypo.del.imp = factor(ifelse(is.na(mental.stat.subtype.imp), NA,
                               ifelse(mental.stat.subtype.imp %in%
                                        c('Both hypo- and hyperactive delirium',
                                          'Hypoactive delirium'), 1, 0)),
                               levels = 0:1, labels = c('No', 'Yes')),
         ## Types of hypoactive delirium: on or off sedation (benzos/propofol)
         sed.hypo.del.today = factor(ifelse(is.na(hypo.del.today), NA,
                                     ifelse(hypo.del.today == 'Yes' & on.sedation, 1, 0)),
                                     levels = 0:1, labels = c('No', 'Yes')),
         sed.hypo.del.imp = factor(ifelse(is.na(hypo.del.imp), NA,
                                   ifelse(hypo.del.imp == 'Yes' & on.sedation, 1, 0)),
                                   levels = 0:1, labels = c('No', 'Yes')),
         hyper.del.today = factor(ifelse(is.na(mental.stat.subtype), NA,
                                  ifelse(mental.stat.subtype %in%
                                           c('Both hypo- and hyperactive delirium',
                                             'Hyperactive delirium'), 1, 0)),
                                  levels = 0:1, labels = c('No', 'Yes')),
         hyper.del.imp = factor(ifelse(is.na(mental.stat.subtype.imp), NA,
                                ifelse(mental.stat.subtype.imp %in%
                                         c('Both hypo- and hyperactive delirium',
                                           'Hyperactive delirium'), 1, 0)),
                                levels = 0:1, labels = c('No', 'Yes')))

## Data set with only in-hospital days
all.daily.hosp <- filter(all.daily, !is.na(mental.stat.imp))

```

## Detailed Description of Motoric Subtypes
`r table_nums('describe_byasmt', display = 'cite')` - `r table_nums('describe_bypt', display = 'cite')` describe mental status and motoric subtypes by individual assessment, patient-days, and
by patient.

```{r describe_subtypes_asmt}
## -- Table for all *assessments* ------------------------------------------------------------------
## How many assessments were complete (had non-missing overall CAM + RASS)?
complete.assess <- subset(all.assess, !is.na(rass.daily) & !is.na(cam.daily))
n.complete.assess <- nrow(complete.assess)

## Get Ns for each status/subtype, and within each subtype, for each RASS
n.assess.subtype <- table(complete.assess$mental.stat.motoric)
## Add overall delirium
n.assess.subtype <- c(n.assess.subtype,
                      'Delirium' = sum(n.assess.subtype[c('Hypoactive delirium',
                                                          'Hyperactive delirium')]))
n.rass.hypo <-
  with(subset(complete.assess, mental.stat.motoric == 'Hypoactive delirium'), table(rass.daily))
n.rass.hyper <-
  with(subset(complete.assess, mental.stat.motoric == 'Hyperactive delirium'), table(rass.daily))

## Calculate percentages
pct.assess.subtype <- round((n.assess.subtype / n.complete.assess)*100)
pct.del.subtype <- round((n.assess.subtype[c('Hypoactive delirium', 'Hyperactive delirium')] /
                            n.assess.subtype['Delirium'])*100)
pct.rass.hypo <- round((n.rass.hypo / n.assess.subtype['Hypoactive delirium'])*100)
pct.rass.hyper <- round((n.rass.hyper / n.assess.subtype['Hyperactive delirium'])*100)

## Create table
describe.asmts <- data.frame(rowlabel = c('Total number of assessments',
                                          '',
                                          'Normal (CAM-, RASS > -4)',
                                          'Comatose (RASS -4/-5)',
                                          'Delirious (CAM+, RASS > -4)',
                                          paste0(space.3, 'Hypoactive'),
                                          paste0(space.6, 'RASS -3'),
                                          paste0(space.6, 'RASS -2'),
                                          paste0(space.6, 'RASS -1'),
                                          paste0(space.6, 'RASS 0'),
                                          paste0(space.3, 'Hyperactive'),
                                          paste0(space.6, 'RASS +1'),
                                          paste0(space.6, 'RASS +2'),
                                          paste0(space.6, 'RASS +3'),
                                          paste0(space.6, 'RASS +4')),
                             ncat = c(n.complete.assess,
                                      NA,
                                      n.assess.subtype['Normal'],
                                      n.assess.subtype['Coma'],
                                      n.assess.subtype['Delirium'],
                                      n.assess.subtype['Hypoactive delirium'],
                                      n.rass.hypo['-3'],
                                      n.rass.hypo['-2'],
                                      n.rass.hypo['-1'],
                                      n.rass.hypo['0'],
                                      n.assess.subtype['Hyperactive delirium'],
                                      n.rass.hyper['1'],
                                      n.rass.hyper['2'],
                                      n.rass.hyper['3'],
                                      n.rass.hyper['4']),
                             pctcat = c(100,
                                        NA,
                                        pct.assess.subtype['Normal'],
                                        pct.assess.subtype['Coma'],
                                        pct.assess.subtype['Delirium'],
                                        pct.assess.subtype['Hypoactive delirium'],
                                        pct.rass.hypo['-3'],
                                        pct.rass.hypo['-2'],
                                        pct.rass.hypo['-1'],
                                        pct.rass.hypo['0'],
                                        pct.assess.subtype['Hyperactive delirium'],
                                        pct.rass.hyper['1'],
                                        pct.rass.hyper['2'],
                                        pct.rass.hyper['3'],
                                        pct.rass.hyper['4']))
describe.asmts$npct <- with(describe.asmts, {
  ifelse(rowlabel == 'Total number of assessments', format(ncat, big.mark = ','),
  ifelse(rowlabel == '', '',
  ifelse(!(rowlabel %in% c(paste0(space.3, 'Hypoactive'), paste0(space.3, 'Hyperactive'))),
         paste0(pctcat, '% (', ncat, ')'),
  ifelse(rowlabel == paste0(space.3, 'Hypoactive'),
         paste0(pctcat, '% of all; ',
                pct.del.subtype['Hypoactive delirium'], '% of delirious (', ncat, ')'),
         paste0(pctcat, '% of all; ',
                pct.del.subtype['Hyperactive delirium'], '% of delirious (', ncat, ')'))))) })

## Formatting and caption
rownames(describe.asmts) <- NULL
describe.asmts <- subset(describe.asmts, select = c(rowlabel, npct))
names(describe.asmts) <- c('Assessment Type', '% (N)')

```

#### `r table_nums('describe_byasmt')`
```{r print_desc_assess, results = 'asis'}
pandoc.table(describe.asmts, justify = c('left', 'right'), split.cells = 100)

```

```{r describe_subtypes_days}
## -- Table for all *patient-days* -----------------------------------------------------------------
## Table will have columns for original data and post-imputation data; get number of in-hospital
##  days, number of days with complete assessment
n.hosp.days <- nrow(all.daily.hosp)
n.days.asmt <- nrow(subset(all.daily.hosp, !is.na(mental.stat)))

subtypes.by.day <- all.daily.hosp %>%
  summarise(n.days_org = n.days.asmt,
            n.days_imp = n.hosp.days,
            n.del_org = sum(mental.stat == 'Delirious', na.rm = TRUE),
            n.coma_org = sum(coma.today == 'Coma', na.rm = TRUE),
            n.norm_org = sum(mental.stat == 'Normal', na.rm = TRUE),
            n.anyhypo_org = sum(hypo.del.today == 'Yes', na.rm = TRUE),
            n.sedhypo_org = sum(sed.hypo.del.today == 'Yes', na.rm = TRUE),
            n.anyhyper_org = sum(hyper.del.today == 'Yes', na.rm = TRUE),
            n.onlyhypo_org = sum(mental.stat.subtype == 'Hypoactive delirium', na.rm = TRUE),
            n.onlyhyper_org = sum(mental.stat.subtype == 'Hyperactive delirium', na.rm = TRUE),
            n.bothsubtypes_org =
              sum(mental.stat.subtype == 'Both hypo- and hyperactive delirium', na.rm = TRUE),
            n.del_imp = sum(mental.stat.imp == 'Delirious', na.rm = TRUE),
            n.coma_imp = sum(coma.today.imp == 'Coma', na.rm = TRUE),
            n.norm_imp = sum(mental.stat.imp == 'Normal', na.rm = TRUE),
            n.anyhypo_imp = sum(hypo.del.imp == 'Yes', na.rm = TRUE),
            n.sedhypo_imp = sum(sed.hypo.del.imp == 'Yes', na.rm = TRUE),
            n.anyhyper_imp = sum(hyper.del.imp == 'Yes', na.rm = TRUE),
            n.onlyhypo_imp = sum(mental.stat.subtype.imp == 'Hypoactive delirium', na.rm = TRUE),
            n.onlyhyper_imp = sum(mental.stat.subtype.imp == 'Hyperactive delirium', na.rm = TRUE),
            n.bothsubtypes_imp =
              sum(mental.stat.subtype.imp == 'Both hypo- and hyperactive delirium',
                  na.rm = TRUE)) %>%
  gather(key = subtype, value = nsub) %>%
  separate(subtype, into = c('subtype', 'cohort'), sep = '_') %>%
  mutate(denom.del = ifelse(subtype %in% c('n.coma', 'n.del', 'n.norm'), NA,
                     ifelse(subtype %in% c('n.sedhypo') & cohort == 'org',
                            sum(all.daily.hosp$hypo.del.today == 'Yes', na.rm = TRUE),
                     ifelse(subtype %in% c('n.sedhypo') & cohort == 'imp',
                            sum(all.daily.hosp$hypo.del.imp == 'Yes', na.rm = TRUE),
                     ifelse(cohort == 'org',
                            sum(all.daily.hosp$mental.stat == 'Delirious', na.rm = TRUE),
                            sum(all.daily.hosp$mental.stat.imp == 'Delirious', na.rm = TRUE))))),
         denom.all = ifelse(cohort == 'org', n.days.asmt, n.hosp.days),
         pct.del = round((nsub / denom.del)*100),
         pct.all = round((nsub / denom.all)*100),
         npct = ifelse(subtype == 'n.days', format(nsub, big.mark = ','),
                ifelse(!is.na(pct.del) & subtype == 'n.sedhypo',
                       paste0(pct.all, '% of all; ', pct.del, '% of hypoactive (', nsub, ')'),
                ifelse(!is.na(pct.del),
                       paste0(pct.all, '% of all; ', pct.del, '% of delirious (', nsub, ')'),
                       paste0(pct.all, '% (', nsub, ')'))))) %>%
  select(subtype, cohort, npct) %>%
  spread(key = cohort, value = npct) %>%
  mutate(rowlabel = c(paste0(space.6, 'Any hyperactive'),
                      paste0(space.6, 'Any hypoactive'),
                      paste0(space.6, 'Both hypo- and hyperactive'),
                      paste0(space.3, 'Any coma'), #'Any coma',
                      'Number of patient-days',
                      paste0(space.3, 'Any delirium'), #'Any delirium',
                      paste0(space.3, 'No delirium or coma'), #'No delirium or coma',
                      paste0(space.6, 'Hyperactive only'),
                      paste0(space.6, 'Hypoactive only'),
                      paste0(space.6, space.3, 'Hypoactive on sedation')),
         sortby = c(6, 4, 7, 2, 0, 3, 1, 9, 8, 5)) %>%
  arrange(sortby) %>%
  select(rowlabel, org, imp)

names(subtypes.by.day) <- c('', 'Recorded Data', 'Recorded + Imputed Data')

```

#### `r table_nums('describe_byday')`
Hypoactive delirium "on sedation" indicates that the patient had at least one CAM+ assessment on a
study day on which the total 24h dose of benzodiazepines and/or propofol was greater than 0. Due to
limitations of data collection, we cannot say for sure whether delirium occurred while the patient
was actually on sedatives.

```{r print_desc_day, results = 'asis'}
pandoc.table(subtypes.by.day,
             justify = c('left', 'right', 'right'), split.cells = Inf, split.tables = Inf)

```

```{r describe_subtypes_pt}
## -- Table for all *patients* (using imputed data) ------------------------------------------------
## Function to determine whether patient ever had condition in question
ever.had.this <- function(x, value = 'Yes'){
  factor(as.numeric(sum(x == value, na.rm = TRUE) > 0),
         levels = 0:1, labels = c('No', 'Yes'))
}

days.subtypes <- all.daily.hosp %>%
  group_by(id) %>%
  summarise(ever.hypodel.imp = ever.had.this(hypo.del.imp),
            days.hypodel.imp = sum(hypo.del.imp == 'Yes', na.rm = TRUE),
            ever.sedhypodel.imp = ever.had.this(sed.hypo.del.imp),
            days.sedhypodel.imp = sum(sed.hypo.del.imp == 'Yes', na.rm = TRUE),
            ever.hyperdel.imp = ever.had.this(hyper.del.imp),
            days.hyperdel.imp = sum(hyper.del.imp == 'Yes', na.rm = TRUE),
            ever.bothdel.imp = ever.had.this(mental.stat.subtype.imp,
                                             'Both hypo- and hyperactive delirium'),
            days.bothdel.imp =
              sum(mental.stat.subtype.imp == 'Both hypo- and hyperactive delirium', na.rm = TRUE),
            ever.onlyhypo.imp = ever.had.this(mental.stat.subtype.imp, 'Hypoactive delirium'),
            days.onlyhypo.imp = sum(mental.stat.subtype.imp == 'Hypoactive delirium', na.rm = TRUE),
            ever.onlyhyper.imp = ever.had.this(mental.stat.subtype.imp, 'Hyperactive delirium'),
            days.onlyhyper.imp =
              sum(mental.stat.subtype.imp == 'Hyperactive delirium', na.rm = TRUE)) %>%
  mutate(days.hypodel.exp = ifelse(days.hypodel.imp == 0, NA, days.hypodel.imp),
         days.sedhypodel.exp = ifelse(days.sedhypodel.imp == 0, NA, days.sedhypodel.imp),
         days.hyperdel.exp = ifelse(days.hyperdel.imp == 0, NA, days.hyperdel.imp),
         days.bothdel.exp = ifelse(days.bothdel.imp == 0, NA, days.bothdel.imp),
         days.onlyhypo.exp = ifelse(days.onlyhypo.imp == 0, NA, days.onlyhypo.imp),
         days.onlyhyper.exp = ifelse(days.onlyhyper.imp == 0, NA, days.onlyhyper.imp))

all.oneobs <- left_join(all.oneobs, days.subtypes, by = 'id')
all.oneobs <- upData(all.oneobs,
  labels = c(ever.hypodel.imp = 'Ever had hypoactive delirium',
             ever.sedhypodel.imp = 'Ever had hypoactive delirium on sedation',
             ever.hyperdel.imp = 'Ever had hyperactive delirium',
             ever.onlyhypo.imp = 'Ever had day with only hypoactive delirium',
             ever.onlyhyper.imp = 'Ever had day with only hyperactive delirium',
             ever.bothdel.imp = 'Ever had day with both hypo- and hyperactive delirium',
             days.hypodel.imp = 'Days of hypoactive delirium',
             days.sedhypodel.imp = 'Days of hypoactive delirium on sedation',
             days.hyperdel.imp = 'Days of hyperactive delirium',
             days.bothdel.imp = 'Days of both hypo- and hyperactive delirium',
             days.onlyhypo.imp = 'Days of only hypoactive delirium',
             days.onlyhyper.imp = 'Days of only hyperactive delirium',
             days.hypodel.exp = 'Days of hypoactive delirium among exposed',
             days.sedhypodel.exp = 'Days of hypoactive delirium on sedation among exposed',
             days.hyperdel.exp = 'Days of hyperactive delirium among exposed',
             days.bothdel.exp = 'Days of both hypo- and hyperactive delirium among exposed',
             days.onlyhypo.exp = 'Days of only hypoactive delirium among exposed',
             days.onlyhyper.exp = 'Days of only hyperactive delirium among exposed'))

## Create data set with cohorts "stacked": one for all enrolled patients with data, one for only
## hospital survivors, one for patients included in long-term analyses
all.oneobs.everyone <- subset(all.oneobs, !(id %in% subset(all.pts, withdrew.data)$id))
all.oneobs.everyone$ptgroup <- 1
all.oneobs.survivors <-
  subset(all.oneobs, id %in% subset(all.pts, status.discharge == 'Discharged alive')$id)
all.oneobs.survivors$ptgroup <- 2
all.oneobs.lt <- subset(all.oneobs, id %in% ltpts.either)
all.oneobs.lt$ptgroup <- 3
all.oneobs.desc <- rbind(all.oneobs.everyone, all.oneobs.survivors, all.oneobs.lt) %>%
  mutate(ptgroup = factor(ptgroup,
                          levels = 1:3,
                          labels = c('All Patients',
                                     'Hospital Survivors',
                                     'LT Cognitive Data')))

## Redo labels for factors. Shrug.
all.oneobs.desc <- upData(all.oneobs.desc,
  labels = c(ever.hypodel.imp = 'Ever had hypoactive delirium',
             ever.sedhypodel.imp = 'Ever had hypoactive delirium on sedation',
             ever.hyperdel.imp = 'Ever had hyperactive delirium',
             ever.onlyhypo.imp = 'Ever had day with only hypoactive delirium',
             ever.onlyhyper.imp = 'Ever had day with only hyperactive delirium',
             ever.bothdel.imp = 'Ever had day with both hypo- and hyperactive delirium'))

mental.status.table <- summaryM(coma.s.imp + del.s.imp +
                                  ever.hypodel.imp + days.hypodel.imp + days.hypodel.exp +
                                  ever.sedhypodel.imp + days.sedhypodel.imp + days.sedhypodel.exp +
                                  ever.hyperdel.imp + days.hyperdel.imp + days.hyperdel.exp +
                                  ever.bothdel.imp + days.bothdel.imp + days.bothdel.exp +
                                  ever.onlyhypo.imp + days.onlyhypo.imp + days.onlyhypo.exp +
                                  ever.onlyhyper.imp + days.onlyhyper.imp +
                                  days.onlyhyper.exp ~ ptgroup,
                                data = all.oneobs.desc, continuous = 5)

```

#### `r table_nums('describe_bypt')`
```{r print_desc_pt, results = 'asis'}
html(mental.status.table, rmarkdown = TRUE, prmsd = TRUE, brmsd = TRUE,
     what = '%', npct = 'both', digits = 2, long = TRUE, caption = '', prn = FALSE,
     middle.bold = TRUE, msdsize = markupSpecs$html$smaller)

```
