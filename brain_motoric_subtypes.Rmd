---
title: Motoric Delirium Subtypes vs Discharge & Long-Term Outcomes
author: 'Jennifer Thompson, MPH; Supervisor: Rameela Chandrasekhar, PhD'
date: '`r format(Sys.time(), "%B %d %Y")`'
output:
  html_notebook:
    code_folding: hide
    toc: yes
    toc_depth: 4
    toc_float: yes
  html_document:
    toc: yes
    toc_depth: 2
    toc_float: yes
  pdf_document:
    toc: yes
    toc_depth: 2
abstract: We describe the prevalence of both hypoactive and hyperactive delirium in the BRAIN-ICU
  cohort, then investigate the association of both of these motoric subtypes with discharge location,
  mortality, and long-term cognition.
---

```{r knitr_setup, echo = FALSE, message = FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, results='hide', fig.width = 8)
options(width = 200)
goldenratio <- 1.61803398875
```

```{r general_setup, results='hide'}
library(tidyverse)
library(broom)
library(pander)
library(rms)
library(mice)
library(scales)
library(plotly)

options(grType = 'plotly')

## Spacing for pandoc tables
space.3 <- paste(rep("&nbsp;", 3), collapse = '')
space.6 <- paste(rep("&nbsp;", 6), collapse = '')

## Nate likes this navy
nate.navy <- "#003D79"

## -- Set up figure, table numbering using the captioner package -----------------------------------
library(captioner)
table_nums <- captioner(prefix = 'Table')
figure_nums <- captioner(prefix = 'Figure')

table_nums(name = 'screentable', caption = 'Screening and Enrollment')
table_nums(name = 'exctable', caption = 'Exclusions')
table_nums(name = 'consorttable', caption = 'Patient Status Over Time')
table_nums(name = 'describe_baseinhosp',
           caption = 'Baseline & In-Hospital Characteristics by Cohort')
table_nums(name = 'describe_followup', caption = 'RBANS and Trails B T-Scores, 3 & 12m')
table_nums(name = 'describe_byasmt', caption = 'Status and Motoric Subtypes by Assessment')
table_nums(name = 'describe_byday', caption = 'Status and Motoric Subtypes by Patient-Day')
table_nums(name = 'describe_bypt', caption = 'Status and Motoric Subtypes by Patient')
table_nums(name = 'results_death_inhosp',
           caption = 'Motoric Subtypes and Other Covariates vs In-Hospital Mortality among All Patients')
table_nums(name = 'results_death_12_all',
           caption = 'Motoric Subtypes and Other Covariates vs 12m Mortality among All Patients')
table_nums(name = 'results_death_12_surv',
           caption = 'Motoric Subtypes and Other Covariates vs 12m Mortality among Hospital Survivors')
table_nums(name = 'cognitive_missing', caption = 'Missingness for Cognitive Outcome Models')

figure_nums(name = 'zph_death_inhosp',
            caption = 'Proportional Hazard Assumption, In-Hospital Mortality among All Patients')
figure_nums(name = 'subtypehrs_death_inhosp',
            caption = 'Hazard Ratios (95% CIs) for Motoric Subtypes, In-Hospital Mortality among All Patients')
figure_nums(name = 'zph_death_12_all',
            caption = 'Proportional Hazard Assumption, 12m Mortality among All Patients')
figure_nums(name = 'subtypehrs_death_12_all',
            caption = 'Hazard Ratios (95% CIs) for Motoric Subtypes, 12m Mortality among All Patients')
figure_nums(name = 'zph_death_12_surv',
            caption = 'Proportional Hazard Assumption, 12m Mortality among Hospital Survivors')
figure_nums(name = 'subtypehrs_death_12_surv',
            caption = 'Hazard Ratios (95% CIs) for Motoric Subtypes, 12m Mortality among Hospital Survivors')
figure_nums(name = 'hypo_rbans', caption = 'Hypoactive Delirium vs Global Cognition')
figure_nums(name = 'hyper_rbans', caption = 'Hyperactive Delirium vs Global Cognition')

```

```{r combinedata}
## -- Source scripts: ------------------------------------------------------------------------------
##    1. combine_brainmind_datasets.R: Either combines BRAIN+MINDICU data, or sets up BRAIN data,
##       depending on operating system; creates "all.xxxxx" data sets to use in rest of analysis
##    2. timevaryingdata.r: Function to create data sets for time-varying Cox models
##    3. model_results.R: Combines results of rms model fits into a single data frame

## If working with VA data
if(Sys.info()['sysname'] == 'Windows'){
  source('combine_brainmind_datasets.R')
## If using only BRAIN data  
} else{
  ## Home directory (if on Mac, assumes connected to desktop via Samba)
  if(Sys.info()['sysname'] == 'Darwin'){
    home.dir <- '/Volumes'
  } else{
    home.dir <- '/home'
  }
  source(file.path(home.dir, 'thomps23', 'ICUDelirium', 'BRAINICU', 'combine_brainmind_datasets.R'))
  source(file.path(home.dir, 'thomps23', 'ICUDelirium', 'timevarying_data.r'))
  source(file.path(home.dir, 'thomps23', 'R', 'rmsHelpers', 'model_results.R'))
}

```

```{r functions_missingness}
## -- Functions to describe amounts of missingness in a data set -----------------------------------
## -- Calculate how many rows in a given data set are missing a specific variable ------------------
covars.missing <- function(x,  ## string; variable to check
                           df, ## data.frame; data set to check
                           ## vector of covariates to check; defaults to all columns in df
                           covar.list = names(df)){
  ## Data set to use: unique() of all covariates (useful for time-varying data sets, where we only
  ## want one instance of missingness per patient)
  tmp <- unique(df[,covar.list])
  
  ## Number missing
  nmiss <- sum(is.na(tmp[,x]))
  
  ## If there are no missings, return NA; otherwise, return "variable name: N (% rows)"
  if(nmiss == 0){
    return(NA)
  } else{
    ## If available, use variable label; otherwise, variable name
    if(label(df[,x]) != ''){
      vtext <- tolower(label(df[,x]))
    } else{
      vtext <- x
    }
    return(paste0(vtext, ': ', nmiss, ' (', round((nmiss / nrow(tmp))*100), '%)'))
  }
}

## -- Paste all non-missing elements of covars.missing() results together to include in text -------
paste.covars.missing <- function(miss.list){
  if(all(is.na(miss.list))){
    return('')
  } else{
    return(paste(miss.list[!is.na(miss.list)], collapse = '; '))
  }
}

```

```{r functions_tidying}
## -- Function to get estimates, on original or ratio scale, for a main variable at a given --------
## -- level of another variable using summary.rms(). Returns a tidy data frame with columns for ----
## -- main and interacting variable names and levels and numeric columns for effects and CIs. ------
estimate.with.interaction.rms <-
  function(model.obj,  ## character string; name of rms model object
           est.var,    ## string; name of variable for which we want estimate/CI
           est.vals,   ## comparison wanted for main variable; default = datadist() defaults
           int.var,    ## string; name of interacting variable
           int.adjust, ## character or numeric; value to adjust interacting var. to
           want.ratios ## Want ratios (odds, hazard, IRR)?
           ){
  
  ## If no values for est.vals are given, use datadist defaults
  if(missing(est.vals)){
    dd <- get(getOption('datadist'))
    ## First choice is Low/High:effect values, used for numeric variables
    estvar.Low <- dd$limits['Low:effect', est.var]
    estvar.High <- dd$limits['High:effect', est.var]
    ## If variable is not numeric, these values are missing; use Low/High instead
    if(is.na(estvar.Low)){
      estvar.Low <- dd$limits['Low', est.var]
      estvar.High <- dd$limits['High', est.var]
    }
  ## If est.vals is given, must be a vector of length 2
  } else if(length(est.vals) != 2){
    stop('est.vals must be a vector of length 2', call. = FALSE)
  } else{
    estvar.Low <- est.vals[1]
    estvar.High <- est.vals[2]
  }
    
  ## If variable is a character or factor, add extra quotes for inclusion in sprintf()
  if(!is.numeric(estvar.Low)){
    estvar.Low <- paste0("'", estvar.Low, "'")
    estvar.High <- paste0("'", estvar.High, "'")
  }
    
  ## If no value for want.ratios is given, use default based on model type:
  ## Logistic, Cox = yes; all others = no
  if(missing(want.ratios)){
    want.ratios <- length(match.arg(class(get(model.obj)), c('lrm', 'cph'), several.ok = TRUE)) > 0
  }
  
  ## If value for interaction term is character, need to add a set of quotes to use in sprintf()
  if(!is.numeric(int.adjust)){
    int.adjust.summary <- paste0("'", int.adjust, "'")
  } else{
    int.adjust.summary <- int.adjust
  }
  
  ## Use summary.rms() to calculate desired estimate
  summary.text <- sprintf("summary(%s, %s = c(%s, %s), %s = %s, est.all = FALSE, antilog = FALSE)",
                          model.obj, est.var, estvar.Low, estvar.High, int.var, int.adjust.summary)
  summary.obj <- eval(parse(text = summary.text))
  
  ## Use broom to make into a data frame, selecting only row with desired variable, and adding
  ## value that interacting variable is adjusted to
  summary.data <- summary.obj %>%
    tidy() %>%
    separate(.rownames,
             into = c('var.main', 'comp.level', 'ref.level'),
             sep = " - |:",
             fill = 'right') %>%
    filter(var.main == est.var) %>%
    mutate(var.int = int.var,
           adjust.int = int.adjust,
           comp.level = ifelse(is.na(comp.level), High, comp.level),
           ref.level = ifelse(is.na(ref.level), Low, ref.level)) %>%
    ## General cleanup: don't need SE, Type, numeric Low/High columns
    select(var.main, ref.level, comp.level, var.int, adjust.int,
           Effect, Lower.0.95, Upper.0.95)
  
  ## Change variable names to make easier to work with
  names(summary.data) <- tolower(gsub('\\.0\\.95', 'cl', names(summary.data)))
  
  ## If we want ratios, exponentiate effect and CLs
  if(want.ratios){
    summary.data[,c('effect', 'lowercl', 'uppercl')] <-
      exp(summary.data[,c('effect', 'lowercl', 'uppercl')])
  }
  
  return(summary.data)

}

```

```{r functions_formatting}
## -- Function to manually italicize rows in a model results table ---------------------------------
## -- (emphasize.italics.rows doesn't seem to work) ------------------------------------------------
ital.rows <- function(modresults){
  ital.these <- which(modresults[,'df'] == '')
  for(i in ital.these){
    for(j in 1:ncol(modresults)){
      if(modresults[i,j] != ''){
        modresults[i,j] <- paste0('*', trim.spaces(modresults[i,j]), '*')
      }
    }
  }
  modresults
}

## -- Function to "move" model stats to estimate/CI column to prep for merging ---------------------
move.stats <- function(df){
  df %>%
    mutate(est.ci = ifelse(low != '' & high == '', low, est.ci),
           low = ifelse(low != '' & high == '', '', low))
}

## -- Function to insert line breaks between point estimates and confidence limits -----------------
ci.newline <- function(df){
  df %>% mutate(est.ci = gsub(' (', '\\\n(', est.ci, fixed = TRUE))
}

```

```{r fu_datamgmt}
## -- Determine whether patients had at least partial followup at each time point, defined as ------
## -- at least one RBANS domain, Trails B, and/or MMSE ---------------------------------------------
cog.outcomes <- c('rbans.global.score', 'rbans.immmemory.tscore', 'rbans.delayedmem.tscore',
                  'rbans.visuo.tscore', 'rbans.attention.tscore', 'rbans.language.tscore',
                  'trail.b.tscore', 'mmse.tscore')

all.fu$n.cog.tests <- rowSums(!is.na(all.fu[,cog.outcomes]))
all.fu$cog.test.status <- with(all.fu, factor(ifelse(n.cog.tests == 0, 1,
                                              ifelse(n.cog.tests == length(cog.outcomes), 3, 2)),
                                              levels = 1:3,
                                              labels = c('No cognitive data',
                                                         'Partial cognitive data',
                                                         'Complete cognitive data')))

## Original data set has one record per followup time; transpose so that 3, 12m info is in separate
## variables (wide format)
followup.status <- all.fu %>%
  filter(fu.period %in% c('3 Month', '12 Month')) %>%
  select(id, fu.period, status, cog.test.status, one_of(cog.outcomes)) %>%
  mutate(fu.period = gsub(' Month', '', fu.period)) %>%
  gather(key = var, value = varvalue, status:mmse.tscore) %>%
  unite(var.time, var, fu.period, sep = '.') %>%
  spread(key = var.time, value = varvalue)

## Force test scores back to numeric
test.cols <- names(followup.status) %in% c(paste0(cog.outcomes, '.3'), paste0(cog.outcomes, '.12'))
for(i in 1:length(test.cols)){
  if(test.cols[i]){
    followup.status[,i] <- as.numeric(followup.status[,i])
  }
}

## -- Add cognitive scores and status at each time point onto all.oneobs ---------------------------
all.oneobs <- all.oneobs %>% left_join(followup.status, by = 'id')
all.oneobs <- upData(all.oneobs,
  labels = c(rbans.global.score.3 = 'RBANS global score, 3m',
             rbans.global.score.12 = 'RBANS global score, 12m',
             trail.b.tscore.3 = 'Trails B t-score, 3m',
             trail.b.tscore.12 = 'Trails B t-score, 12m'))

```

```{r cuberoot_drugs}
## -- Create cube root-transformed versions of drug variables in daily and summary data sets -------
all.daily <- all.daily %>%
  mutate(tot.benz.cube = tot.benz**(1/3),
         tot.op.cube = tot.op**(1/3),
         tot.prop.cube = tot.prop**(1/3),
         tot.dex.cube = tot.dex**(1/3),
         tot.hal.cube = tot.hal**(1/3))
all.daily <- upData(all.daily,
  labels = c(tot.benz.cube = '24h benzodiazepines, cube root',
             tot.op.cube = '24h opioids, cube root',
             tot.prop.cube = '24h propofol, cube root',
             tot.dex.cube = '24h dexmedetomidine, cube root',
             tot.hal.cube = '24h haloperidol, cube root'))

all.oneobs <- all.oneobs %>%
  mutate(mean.benz.cube = mean.benz.icu**(1/3),
         mean.op.cube = mean.op.icu**(1/3),
         mean.prop.cube = mean.prop.icu**(1/3),
         mean.dex.cube = mean.dex.icu**(1/3),
         mean.hal.cube = mean.hal.icu**(1/3))
all.oneobs <- upData(all.oneobs,
  labels = c(mean.benz.cube = 'Mean 24h benzodiazepines in ICU, cube root',
             mean.op.cube = 'Mean 24h opioids in ICU, cube root',
             mean.prop.cube = 'Mean 24h propofol in ICU, cube root',
             mean.dex.cube = 'Mean 24h dexmedetomidine in ICU, cube root',
             mean.hal.cube = 'Mean 24h haloperidol in ICU, cube root'))

```
# Description of Cohort
## Screening, Exclusions, Enrollment, and Patient Status
`r table_nums('screentable', display = 'cite')` shows the number of patients screened, enrolled and
excluded in the entire cohort; `r table_nums('exctable', display = 'cite')` presents the reasons for exclusion. `r table_nums('consorttable', display = 'cite')` shows the status of each patient over
both the in-hospital and followup periods.

```{r consortinfo}
## -- Create data frame of all screened patients, exclusion reasons, and status at each time -------
## -- point: enrollment, discharge, 3m, 12m --------------------------------------------------------
all.exc$id <- all.exc$ex.id

all.pts <- merge(subset(all.exc, select = c(id, exc.rsn.2)),
                 subset(all.oneobs, select = c(id, withdrew.data, studywd.amt, died.inhosp)),
                 by = 'id', all = TRUE) %>%
  left_join(select(followup.status, id, status.3, cog.test.status.3, status.12, cog.test.status.12),
            by = 'id') %>%
  mutate(## Status at enrollment: excluded, refused, or enrolled
         was.approached = is.na(exc.rsn.2) | exc.rsn.2 == 'Surrogate or patient refused consent',
         refused.consent = !is.na(exc.rsn.2) & exc.rsn.2 == 'Surrogate or patient refused consent',
         was.enrolled = is.na(exc.rsn.2),
         status.enroll = factor(ifelse(!was.approached, 1,
                                ifelse(refused.consent, 2, 3)),
                                levels = 1:3,
                                labels = c('Excluded', 'Refused', 'Enrolled')),
         ## Indicator for whether to be included in any analyses: enrolled and kept some data
         include.main = status.enroll == 'Enrolled' & !withdrew.data,
         ## Status at discharge: discharged alive, withdrew, died in hospital
         status.discharge = factor(ifelse(!was.enrolled | withdrew.data, NA,
                                   ifelse(died.inhosp == 'Died in hospital', 1,
                                   ifelse(!is.na(studywd.amt), 2, 3))),
                                   levels = 1:3,
                                   labels = c('Died in hospital',
                                              'Withdrew in hospital',
                                              'Discharged alive')),
         ## Indicator for whether to include in hospital survivors cohort: enrolled, survived
         ## hospital stay and still in study
         include.survivors = status.enroll == 'Enrolled' & !withdrew.data &
           status.discharge == 'Discharged alive',
         ## Status at 3 months: died between discharge and followup, withdrew between discharge
         ## and followup, permanently lost to followup, temporarily lost to followup, or tested
         status.3m = factor(ifelse(is.na(status.discharge) |
                                     status.discharge %in% c('Died in hospital',
                                                             'Withdrew in hospital'), NA,
                            ifelse(status.3 == 'Deceased', 1,
                            ifelse(status.3 == 'Living-Withdrew from the study', 2,
                            ifelse(cog.test.status.3 == 'No cognitive data' &
                                     (is.na(cog.test.status.12) |
                                        cog.test.status.12 == 'No cognitive data'), 3,
                            ifelse(cog.test.status.3 == 'No cognitive data', 4,
                            ifelse(cog.test.status.3 == 'Partial cognitive data', 5,
                            ifelse(cog.test.status.3 == 'Complete cognitive data', 6, NA))))))),
                            levels = 1:6,
                            labels = c('Died before 3m followup',
                                       'Withdrew before 3m followup',
                                       'Permanently lost to followup',
                                       'Temporarily lost to followup',
                                       'Partial cognitive testing',
                                       'Complete cognitive testing')),
         ## Include in main analysis at 3 months: if at least partial cognitive data
         include.3m = !is.na(status.3m) & status.3m %in%
           paste(c('Partial', 'Complete'), 'cognitive testing'),
         ## Status at 12 months: died between discharge and followup, withdrew between discharge
         ## and followup, lost to followup, or tested
         status.12m = factor(ifelse(is.na(status.3m) |
                                     status.3m %in% c('Died before 3m followup',
                                                      'Withdrew before 3m followup'), NA,
                            ifelse(status.12 == 'Deceased', 1,
                            ifelse(status.12 == 'Living-Withdrew from the study', 2,
                            ifelse(cog.test.status.12 == 'No cognitive data', 3,
                            ifelse(cog.test.status.12 == 'Partial cognitive data', 4,
                            ifelse(cog.test.status.12 == 'Complete cognitive data', 5, NA)))))),
                            levels = 1:5,
                            labels = c('Died before 12m followup',
                                       'Withdrew before 12m followup',
                                       'Lost to followup',
                                       'Partial cognitive testing',
                                       'Complete cognitive testing')),
         ## Include in main analysis at 12 months: if at least partial cognitive data
         include.12m = !is.na(status.12m) & status.12m %in%
           paste(c('Partial', 'Complete'), 'cognitive testing'))

## Create vectors of IDs of patients included in analyses at each time point
pts.survived <- as.numeric(subset(all.pts, include.survivors)$id)
ltpts.either <- as.numeric(subset(all.pts, include.3m | include.12m)$id)
ltpts.3m <- as.numeric(subset(all.pts, include.3m)$id)
ltpts.12m <- as.numeric(subset(all.pts, include.12m)$id)

```

```{r screen_table}
## -- Table: Screening and enrollment --------------------------------------------------------------
## Assign numerators and denominators for each category
n.screened <- nrow(all.pts)
n.excluded <- sum(all.pts$status.enroll == 'Excluded')
d.excluded <- n.screened
n.approached <- sum(all.pts$was.approached)
d.approached <- n.screened
n.refused <- sum(all.pts$refused.consent)
d.refused <- n.approached
n.enrolled <- sum(all.pts$was.enrolled)
d.enrolled <- n.approached
n.withdrewdata <- sum(all.pts$withdrew.data, na.rm = TRUE)
d.withdrewdata <- n.enrolled
n.included <- sum(all.pts$include.main)
d.included <- n.enrolled

screen.table <- data.frame(spacing = c('', rep(space.3, 2), rep(space.6, 2),
                                       rep(paste0(space.3, space.6), 2)),
                           rowlabel = c('Screened', 'Excluded', 'Approached', 'Refused', 'Enrolled',
                                        'Withdrew all data', 'Included in analyses'),
                           npts = c(n.screened, n.excluded, n.approached, n.refused, n.enrolled,
                                    n.withdrewdata, n.included),
                           dpts = c(NA, d.excluded, d.approached, d.refused, d.enrolled,
                                    d.withdrewdata, d.included)) %>%
  mutate(pctpts = round((npts / dpts)*100),
         npct = ifelse(is.na(dpts), format(npts, big.mark = ','),
                       paste0(format(npts, big.mark = ','), ' (', pctpts, '%)')),
         final.rowlabel = ifelse(rowlabel == 'Included in analyses',
                                 paste0(spacing, '**', rowlabel, '**'),
                                 paste0(spacing, rowlabel))) %>%
  select(final.rowlabel, npct)

names(screen.table) <- c('', 'N (%)')

```


#### `r table_nums('screentable')`
```{r print_screentable, results = 'asis'}
pandoc.table(screen.table, justify = c('left', 'right'), split.cells = Inf, split.table = Inf)

```

#### `r table_nums('exctable')`
```{r exctable}
exc.ns <- all.exc %>%
  group_by(exc.rsn.2) %>%
  summarise(exc.n = n()) %>%
  filter(exc.rsn.2 != 'Surrogate or patient refused consent') %>%
  mutate(exc.pct = round((exc.n / n.excluded)*100),
         exc.npct = paste0(exc.pct, '% (', exc.n, ')')) %>%
  arrange(desc(exc.pct)) %>%
  select(exc.rsn.2, exc.npct)

names(exc.ns) <- c('Exclusion', '% (N)')

```
```{r print_exctable, results = 'asis'}
pandoc.table(exc.ns, justify = c('left', 'right'), split.cells = Inf, split.table = Inf)

```

```{r consort_table}
## -- Table: Enrolled patient status ---------------------------------------------------------------
## Assign numerators and denominators for each category
n.died.inhosp <- sum(all.pts$status.discharge == 'Died in hospital', na.rm = TRUE)
n.wd.inhosp <- sum(all.pts$status.discharge == 'Withdrew in hospital', na.rm = TRUE)
n.surv.inhosp <- sum(all.pts$status.discharge == 'Discharged alive', na.rm = TRUE)
d.died.inhosp <- d.wd.inhosp <- d.surv.inhosp <- n.included

lost.to.fu <- c('Permanently lost to followup', 'Temporarily lost to followup', 'Lost to followup')
elig.for.fu <- c(lost.to.fu, 'Partial cognitive testing', 'Complete cognitive testing')

n.died.3m <- sum(all.pts$status.3m == 'Died before 3m followup', na.rm = TRUE)
n.wd.3m <- sum(all.pts$status.3m == 'Withdrew before 3m followup', na.rm = TRUE)
n.elig.3m <- sum(all.pts$status.3m %in% elig.for.fu, na.rm = TRUE)
d.died.3m <- d.wd.3m <- d.elig.3m <- n.surv.inhosp

n.lost.3m <- sum(all.pts$status.3m %in% lost.to.fu, na.rm = TRUE)
n.permlost.3m <- sum(all.pts$status.3m == 'Permanently lost to followup', na.rm = TRUE)
n.templost.3m <- sum(all.pts$status.3m == 'Temporarily lost to followup', na.rm = TRUE)
n.inc.3m <- sum(all.pts$include.3m)
n.part.3m <- sum(all.pts$status.3m == 'Partial cognitive testing', na.rm = TRUE)
n.comp.3m <- sum(all.pts$status.3m == 'Complete cognitive testing', na.rm = TRUE)

d.lost.3m <- d.inc.3m <- n.elig.3m
d.permlost.3m <- d.templost.3m <- n.lost.3m
d.part.3m <- d.comp.3m <- n.inc.3m

n.died.12m <- sum(all.pts$status.12m == 'Died before 12m followup', na.rm = TRUE)
n.wd.12m <- sum(all.pts$status.12m == 'Withdrew before 12m followup', na.rm = TRUE)
n.elig.12m <- sum(all.pts$status.12m %in% elig.for.fu, na.rm = TRUE)
d.died.12m <- d.wd.12m <- d.elig.12m <- n.elig.3m

n.lost.12m <- sum(all.pts$status.12m %in% lost.to.fu, na.rm = TRUE)
n.inc.12m <- sum(all.pts$include.12m)
n.part.12m <- sum(all.pts$status.12m == 'Partial cognitive testing', na.rm = TRUE)
n.comp.12m <- sum(all.pts$status.12m == 'Complete cognitive testing', na.rm = TRUE)

d.lost.12m <- d.inc.12m <- n.elig.12m
d.part.12m <- d.comp.12m <- n.inc.12m

n.elig.either <- length(ltpts.either)
d.elig.either <- n.surv.inhosp

consort.table <- data.frame(spacing = c(rep('', 9),
                                        space.3, space.6, space.6,
                                        space.3, space.6, space.6, '',
                                        rep('', 3), space.3, space.3, space.6, space.6, '', ''),
                            rowlabel = c('Main cohort', '&nbsp;',
                                         'Died in hospital', 'Withdrew in hospital',
                                         'Discharged alive, remained in study', '&nbsp;',
                                         'Died before 3m followup', 'Withdrew before 3m followup',
                                         'Eligible for 3m outcomes',
                                         'Lost to followup', 'Permanently (no 12m data)',
                                         'Temporarily (had 12m data)',
                                         'Had 3m outcomes', 'Partial', 'Complete', '&nbsp;',
                                         'Died before 12m followup', 'Withdrew before 12m followup',
                                         'Eligible for 12m outcomes', 'Lost to followup',
                                         'Had 12m outcomes', 'Partial', 'Complete', '&nbsp;',
                                         'Eligible for LT outcomes analyses, either time point'),
                            npts = c(n.included, NA,
                                     n.died.inhosp, n.wd.inhosp, n.surv.inhosp, NA,
                                     n.died.3m, n.wd.3m, n.elig.3m,
                                     n.lost.3m, n.permlost.3m, n.templost.3m,
                                     n.inc.3m, n.part.3m, n.comp.3m, NA,
                                     n.died.12m, n.wd.12m, n.elig.12m, n.lost.12m,
                                     n.inc.12m, n.part.12m, n.comp.12m, NA, n.elig.either),
                            dpts = c(NA, NA,
                                     d.died.inhosp, d.wd.inhosp, d.surv.inhosp, NA,
                                     d.died.3m, d.wd.3m, d.elig.3m,
                                     d.lost.3m, d.permlost.3m, d.templost.3m,
                                     d.inc.3m, d.part.3m, d.comp.3m, NA,
                                     d.died.12m, d.wd.12m, d.elig.12m, d.lost.12m,
                                     d.inc.12m, d.part.12m, d.comp.12m, NA, d.elig.either)) %>%
  mutate(pctpts = round((npts / dpts)*100),
         npct = ifelse(is.na(npts), '',
                ifelse(is.na(pctpts), format(npts, big.mark = ','),
                       paste0(format(npts, big.mark = ','), ' (', pctpts, '%)'))),
         final.rowlabel = paste0(spacing, rowlabel)) %>%
  select(final.rowlabel, npct)

names(consort.table) <- c('', 'N (%)')

```

#### `r table_nums('consorttable')`
```{r print_consorttable, results = 'asis'}
pandoc.table(consort.table, justify = c('left', 'right'), split.cells = Inf, split.table = Inf)

```

## Patient Characteristics
`r table_nums('describe_baseinhosp', display = 'cite')` describes baseline and in-hospital
characteristics for all patients, hospital survivors, and patients with at least some long-term
cognitive followup data. `r table_nums('describe_followup', display = 'cite')` describes RBANS and
Trails B scores at each followup time point.

#### `r table_nums('describe_baseinhosp')`
```{r describe_baseinhosp}
## Create data set with cohorts "stacked": one for all enrolled patients with data, one for only
## hospital survivors, one for patients included in long-term analyses
all.oneobs.everyone <- subset(all.oneobs, !(id %in% subset(all.pts, withdrew.data)$id))
all.oneobs.everyone$ptgroup <- 1
all.oneobs.survivors <-
  subset(all.oneobs, id %in% subset(all.pts, status.discharge == 'Discharged alive')$id)
all.oneobs.survivors$ptgroup <- 2
all.oneobs.lt <- subset(all.oneobs, id %in% ltpts.either)
all.oneobs.lt$ptgroup <- 3
all.oneobs.desc <- rbind(all.oneobs.everyone, all.oneobs.survivors, all.oneobs.lt) %>%
  mutate(ptgroup = factor(ptgroup,
                          levels = 1:3,
                          labels = c('All Patients',
                                     'Hospital Survivors',
                                     'LT Cognitive Data')))

## Redo labels for factors. Shrug.
all.oneobs.desc <- upData(all.oneobs.desc,
  labels = c(sex.pp = 'Sex',
             race.pp = 'Race',
             ins.pp = 'Insurance',
             frailty = 'CSHA Frailty',
             icu.type = 'ICU type',
             ever.vent = 'Ever on MV',
             died.inhosp = 'Died in the hospital'))

```

```{r print_describe_baseinhosp, results = 'asis'}
html(summaryM(age.enroll + sex.pp + race.pp + edu + ins.pp + frailty + adl.e + faq.e +
                iqcode.score.e + icu.type + sofa + num.apache + charlson.score + ever.vent +
                vent.los.tot.eo + mean.benz.icu + mean.op.icu + mean.prop.icu + mean.dex.icu +
                mean.hal.icu + mean.sofa.icu + icudays.sevseptic.s + icu.los.tot + hosp.los +
                died.inhosp ~ ptgroup,
              data = all.oneobs.desc),
     rmarkdown = TRUE, prmsd = TRUE, brmsd = TRUE,
     what = '%', npct = 'both', digits = 2, exclude1 = FALSE, long = TRUE, caption = '',
     prn = FALSE, middle.bold = TRUE, msdsize = markupSpecs$html$smaller)

```

#### `r table_nums('describe_followup')`
```{r describe_fu, results = 'asis'}
html(summaryM(rbans.global.score.3 + rbans.global.score.12 +
                trail.b.tscore.3 + trail.b.tscore.12 ~ 1,
              data = subset(all.oneobs, id %in% ltpts.either)),
     rmarkdown = TRUE, prn = TRUE, prmsd = TRUE, brmsd = TRUE,
     digits = 2, caption = '', middle.bold = TRUE, msdsize = markupSpecs$html$smaller)

```

# Primary Exposure: Motoric Subtypes of Delirium
Most of the variables included in these analyses have been documented or discussed elsewhere. The
exposure variables specific to this analysis are hypo- and hyperactive delirium, generally referred
to as motoric subtypes.

For any given CAM/RASS assessment, a patient was considered to have hypoactive delirium if he or she
was CAM+ and had a RASS <= 0. A patient was considered to have hyperactive delirium if he or she was
CAM+ but had a RASS > 0. A day could have both hypoactive and hyperactive delirium assessments, if
the patient was in the ICU and was delirious at both research staff assessments.

## Handling Missingness
If a patient had no mental status assessment on an in-hospital study day, we originally used
single imputation to impute an overall status (normal, delirious or comatose), based on the status
on the days immediately prior to and after the missing day. If a missing study day was assigned a
normal or comatose status during single imputation, we assumed no hypoactive or hyperactive
delirium. For days which were assigned a delirious status, we imputed indicators for whether
delirium was hypoactive or hyperactive based on overall mental status, coma, and motoric subtypes on
the days immediately prior to and after the missing day.

```{r datamgmt_subtypes}
## -- Determine whether pt had hypoactive or hyperactive delirium at each single *assessment* ------
all.assess <- all.assess %>%
  left_join(select(all.daily, id, study.date, study.day),
            by = c('id' = 'id', 'asmt.date' = 'study.date')) %>%
  mutate(mental.stat.motoric = factor(ifelse(is.na(mental.stat), NA,
                                      ifelse(mental.stat == 'Normal', 1,
                                      ifelse(mental.stat == 'Delirious' &
                                               is.na(rass.daily) | !(rass.daily %in% -5:4), 2,
                                      ifelse(mental.stat == 'Delirious' & rass.daily <= 0, 3,
                                      ifelse(mental.stat == 'Delirious' & rass.daily > 0, 4,
                                      ifelse(mental.stat == 'Comatose', 5, NA)))))),
                                      levels = 1:5,
                                      labels = c('Normal', 'Delirium, no RASS',
                                                 'Hypoactive delirium', 'Hyperactive delirium',
                                                 'Coma')))

## -- Determine how much hypoactive/hyperactive delirium pt had on each study *day* ----------------
motoric.byday <- all.assess %>%
  group_by(id, study.day) %>%
  summarise(n.asmts = sum(!is.na(mental.stat.motoric)),
            normal.asmts = sum(mental.stat.motoric == 'Normal', na.rm = TRUE),
            hypo.del.asmts = sum(mental.stat.motoric == 'Hypoactive delirium', na.rm = TRUE),
            hyper.del.asmts = sum(mental.stat.motoric == 'Hyperactive delirium', na.rm = TRUE),
            coma.asmts = sum(mental.stat.motoric == 'Coma', na.rm = TRUE)) %>%
  mutate(mental.stat.subtype = factor(ifelse(n.asmts == 0, NA,
                                      ifelse(hypo.del.asmts > 0 & hyper.del.asmts > 0, 3,
                                      ifelse(hypo.del.asmts > 0, 4,
                                      ifelse(hyper.del.asmts > 0, 2,
                                      ifelse(coma.asmts > 0, 5,
                                      ifelse(normal.asmts > 0, 1, NA)))))),
                                      levels = 1:5,
                                      labels = c('No delirium or coma',
                                                 'Hyperactive delirium',
                                                 'Both hypo- and hyperactive delirium',
                                                 'Hypoactive delirium',
                                                 'No delirium; had coma')))

## Add daily subtypes back onto main daily data set
all.daily <- all.daily %>%
  left_join(select(motoric.byday, id, study.day, mental.stat.subtype),
            by = c('id', 'study.day'))

## -- Impute mental status incorporating subtypes for days with no assessment which were -----------
## -- assigned delirium in original single imputation ----------------------------------------------
subtype.impdata <- all.daily %>%
  select(id, study.day, mental.stat.imp, mental.stat.subtype, stat.before.imp, stat.after.imp,
         coma.today) %>%
  group_by(id) %>%
  ## Create variables for mental status + subtypes, coma yesterday and tomorrow
  mutate(mental.subtype.yday = lag(mental.stat.subtype),
         mental.subtype.tmw = lead(mental.stat.subtype),
         coma.yday = lag(coma.today),
         coma.tmw = lead(coma.today),
         ## Initialize imputed version of mental status + subtypes, incorporating normal/coma
         ## imputation from original data set
         del.subtype = factor(ifelse(!is.na(mental.stat.subtype), as.character(mental.stat.subtype),
                                     NA))) %>%
  ungroup() %>%
  ## Restrict to only delirium days; otherwise delirium days might get imputed as normal or coma
  filter(mental.stat.imp == 'Delirious') %>%
  ## Some variables need to be refactored - original factor levels (Deceased, Discharged,
  ## Withdrawn) don't show up in this data set and cause errors in imputation
  select(-mental.stat.subtype, -mental.stat.imp) %>%
  mutate(stat.before.imp = factor(as.character(stat.before.imp)),
         coma.today = factor(as.character(coma.today)),
         coma.yday = factor(as.character(coma.yday)),
         coma.tmw = factor(as.character(coma.tmw)),
         del.subtype = factor(as.character(del.subtype)))

## predictorMatrix for mice(): uses all covariates except ID for motoric subtype variable, none
## for all others
impdata.cols <- ncol(subtype.impdata)
subtype.predmatrix <- matrix(c(rep(0, impdata.cols*(impdata.cols - 1)),
                               c(0, rep(1, impdata.cols - 1))),
                             byrow = TRUE, ncol = impdata.cols)

## Perform single imputation (only one imputation) and get complete data set
subtype.mice <- mice(subtype.impdata, m = 1, predictorMatrix = subtype.predmatrix, seed = 56)
subtype.mice.complete <- complete(subtype.mice)

## Create final version of imputed mental status + subtype, and create indicators for whether
## patient had hypoactive and hyperactive delirium each day
all.daily <- all.daily %>%
  left_join(select(subtype.mice.complete, id, study.day, del.subtype),
            by = c('id', 'study.day')) %>%
  mutate(## Indicator for whether patient was on sedation (benzodiazepines and/or propofol)
         on.sedation = ifelse(is.na(mental.stat.imp), NA,
                              ((!is.na(tot.benz) & tot.benz > 0) |
                                 (!is.na(tot.prop) & tot.prop > 0))),
         mental.stat.subtype.imp =
           factor(ifelse(is.na(mental.stat.imp), NA,
                  ifelse(mental.stat.imp == 'Normal', 1,
                  ifelse(mental.stat.imp == 'Comatose', 5,
                  ifelse(!is.na(del.subtype) & del.subtype == 'Hyperactive delirium', 2,
                  ifelse(!is.na(del.subtype) & del.subtype == 'Both hypo- and hyperactive delirium',
                         3,
                  ifelse(!is.na(del.subtype) & del.subtype == 'Hypoactive delirium', 4, NA)))))),
                  levels = 1:5,
                  labels = levels(all.daily$mental.stat.subtype)),
         hypo.del.today = factor(ifelse(is.na(mental.stat.subtype), NA,
                                 ifelse(mental.stat.subtype %in%
                                          c('Both hypo- and hyperactive delirium',
                                            'Hypoactive delirium'), 1, 0)),
                                 levels = 0:1, labels = c('No', 'Yes')),
         hypo.del.imp = factor(ifelse(is.na(mental.stat.subtype.imp), NA,
                               ifelse(mental.stat.subtype.imp %in%
                                        c('Both hypo- and hyperactive delirium',
                                          'Hypoactive delirium'), 1, 0)),
                               levels = 0:1, labels = c('No', 'Yes')),
         ## Types of hypoactive delirium: on or off sedation (benzos/propofol)
         sed.hypo.del.today = factor(ifelse(is.na(hypo.del.today), NA,
                                     ifelse(hypo.del.today == 'Yes' & on.sedation, 1, 0)),
                                     levels = 0:1, labels = c('No', 'Yes')),
         sed.hypo.del.imp = factor(ifelse(is.na(hypo.del.imp), NA,
                                   ifelse(hypo.del.imp == 'Yes' & on.sedation, 1, 0)),
                                   levels = 0:1, labels = c('No', 'Yes')),
         hyper.del.today = factor(ifelse(is.na(mental.stat.subtype), NA,
                                  ifelse(mental.stat.subtype %in%
                                           c('Both hypo- and hyperactive delirium',
                                             'Hyperactive delirium'), 1, 0)),
                                  levels = 0:1, labels = c('No', 'Yes')),
         hyper.del.imp = factor(ifelse(is.na(mental.stat.subtype.imp), NA,
                                ifelse(mental.stat.subtype.imp %in%
                                         c('Both hypo- and hyperactive delirium',
                                           'Hyperactive delirium'), 1, 0)),
                                levels = 0:1, labels = c('No', 'Yes')))

## Data set with only in-hospital days
all.daily.hosp <- filter(all.daily, !is.na(mental.stat.imp))

```

## Detailed Description of Motoric Subtypes
`r table_nums('describe_byasmt', display = 'cite')` - `r table_nums('describe_bypt', display = 'cite')` describe mental status and motoric subtypes by individual assessment, patient-days, and
by patient.

```{r describe_subtypes_asmt}
## -- Table for all *assessments* ------------------------------------------------------------------
## How many assessments were complete (had non-missing overall CAM + RASS)?
complete.assess <- subset(all.assess, !is.na(rass.daily) & !is.na(cam.daily))
n.complete.assess <- nrow(complete.assess)

## Get Ns for each status/subtype, and within each subtype, for each RASS
n.assess.subtype <- table(complete.assess$mental.stat.motoric)
## Add overall delirium
n.assess.subtype <- c(n.assess.subtype,
                      'Delirium' = sum(n.assess.subtype[c('Hypoactive delirium',
                                                          'Hyperactive delirium')]))
n.rass.hypo <-
  with(subset(complete.assess, mental.stat.motoric == 'Hypoactive delirium'), table(rass.daily))
n.rass.hyper <-
  with(subset(complete.assess, mental.stat.motoric == 'Hyperactive delirium'), table(rass.daily))

## Calculate percentages
pct.assess.subtype <- round((n.assess.subtype / n.complete.assess)*100)
pct.del.subtype <- round((n.assess.subtype[c('Hypoactive delirium', 'Hyperactive delirium')] /
                            n.assess.subtype['Delirium'])*100)
pct.rass.hypo <- round((n.rass.hypo / n.assess.subtype['Hypoactive delirium'])*100)
pct.rass.hyper <- round((n.rass.hyper / n.assess.subtype['Hyperactive delirium'])*100)

## Create table
describe.asmts <- data.frame(rowlabel = c('Total number of assessments',
                                          '',
                                          'Normal (CAM-, RASS > -4)',
                                          'Comatose (RASS -4/-5)',
                                          'Delirious (CAM+, RASS > -4)',
                                          paste0(space.3, 'Hypoactive'),
                                          paste0(space.6, 'RASS -3'),
                                          paste0(space.6, 'RASS -2'),
                                          paste0(space.6, 'RASS -1'),
                                          paste0(space.6, 'RASS 0'),
                                          paste0(space.3, 'Hyperactive'),
                                          paste0(space.6, 'RASS +1'),
                                          paste0(space.6, 'RASS +2'),
                                          paste0(space.6, 'RASS +3'),
                                          paste0(space.6, 'RASS +4')),
                             ncat = c(n.complete.assess,
                                      NA,
                                      n.assess.subtype['Normal'],
                                      n.assess.subtype['Coma'],
                                      n.assess.subtype['Delirium'],
                                      n.assess.subtype['Hypoactive delirium'],
                                      n.rass.hypo['-3'],
                                      n.rass.hypo['-2'],
                                      n.rass.hypo['-1'],
                                      n.rass.hypo['0'],
                                      n.assess.subtype['Hyperactive delirium'],
                                      n.rass.hyper['1'],
                                      n.rass.hyper['2'],
                                      n.rass.hyper['3'],
                                      n.rass.hyper['4']),
                             pctcat = c(100,
                                        NA,
                                        pct.assess.subtype['Normal'],
                                        pct.assess.subtype['Coma'],
                                        pct.assess.subtype['Delirium'],
                                        pct.assess.subtype['Hypoactive delirium'],
                                        pct.rass.hypo['-3'],
                                        pct.rass.hypo['-2'],
                                        pct.rass.hypo['-1'],
                                        pct.rass.hypo['0'],
                                        pct.assess.subtype['Hyperactive delirium'],
                                        pct.rass.hyper['1'],
                                        pct.rass.hyper['2'],
                                        pct.rass.hyper['3'],
                                        pct.rass.hyper['4']))
describe.asmts$npct <- with(describe.asmts, {
  ifelse(rowlabel == 'Total number of assessments', format(ncat, big.mark = ','),
  ifelse(rowlabel == '', '',
  ifelse(!(rowlabel %in% c(paste0(space.3, 'Hypoactive'), paste0(space.3, 'Hyperactive'))),
         paste0(pctcat, '% (', ncat, ')'),
  ifelse(rowlabel == paste0(space.3, 'Hypoactive'),
         paste0(pctcat, '% of all; ',
                pct.del.subtype['Hypoactive delirium'], '% of delirious (', ncat, ')'),
         paste0(pctcat, '% of all; ',
                pct.del.subtype['Hyperactive delirium'], '% of delirious (', ncat, ')'))))) })

## Formatting and caption
rownames(describe.asmts) <- NULL
describe.asmts <- subset(describe.asmts, select = c(rowlabel, npct))
names(describe.asmts) <- c('Assessment Type', '% (N)')

```

#### `r table_nums('describe_byasmt')`
```{r print_desc_assess, results = 'asis'}
pandoc.table(describe.asmts, justify = c('left', 'right'), split.cells = Inf)

```

```{r describe_subtypes_days}
## -- Table for all *patient-days* -----------------------------------------------------------------
## Table will have columns for original data and post-imputation data; get number of in-hospital
##  days, number of days with complete assessment
n.hosp.days <- nrow(all.daily.hosp)
n.days.asmt <- nrow(subset(all.daily.hosp, !is.na(mental.stat)))

subtypes.by.day <- all.daily.hosp %>%
  summarise(n.days_org = n.days.asmt,
            n.days_imp = n.hosp.days,
            n.del_org = sum(mental.stat == 'Delirious', na.rm = TRUE),
            n.coma_org = sum(coma.today == 'Coma', na.rm = TRUE),
            n.norm_org = sum(mental.stat == 'Normal', na.rm = TRUE),
            n.anyhypo_org = sum(hypo.del.today == 'Yes', na.rm = TRUE),
            n.sedhypo_org = sum(sed.hypo.del.today == 'Yes', na.rm = TRUE),
            n.anyhyper_org = sum(hyper.del.today == 'Yes', na.rm = TRUE),
            n.onlyhypo_org = sum(mental.stat.subtype == 'Hypoactive delirium', na.rm = TRUE),
            n.onlyhyper_org = sum(mental.stat.subtype == 'Hyperactive delirium', na.rm = TRUE),
            n.bothsubtypes_org =
              sum(mental.stat.subtype == 'Both hypo- and hyperactive delirium', na.rm = TRUE),
            n.del_imp = sum(mental.stat.imp == 'Delirious', na.rm = TRUE),
            n.coma_imp = sum(coma.today.imp == 'Coma', na.rm = TRUE),
            n.norm_imp = sum(mental.stat.imp == 'Normal', na.rm = TRUE),
            n.anyhypo_imp = sum(hypo.del.imp == 'Yes', na.rm = TRUE),
            n.sedhypo_imp = sum(sed.hypo.del.imp == 'Yes', na.rm = TRUE),
            n.anyhyper_imp = sum(hyper.del.imp == 'Yes', na.rm = TRUE),
            n.onlyhypo_imp = sum(mental.stat.subtype.imp == 'Hypoactive delirium', na.rm = TRUE),
            n.onlyhyper_imp = sum(mental.stat.subtype.imp == 'Hyperactive delirium', na.rm = TRUE),
            n.bothsubtypes_imp =
              sum(mental.stat.subtype.imp == 'Both hypo- and hyperactive delirium',
                  na.rm = TRUE)) %>%
  gather(key = subtype, value = nsub) %>%
  separate(subtype, into = c('subtype', 'cohort'), sep = '_') %>%
  mutate(denom.del = ifelse(subtype %in% c('n.coma', 'n.del', 'n.norm'), NA,
                     ifelse(subtype %in% c('n.sedhypo') & cohort == 'org',
                            sum(all.daily.hosp$hypo.del.today == 'Yes', na.rm = TRUE),
                     ifelse(subtype %in% c('n.sedhypo') & cohort == 'imp',
                            sum(all.daily.hosp$hypo.del.imp == 'Yes', na.rm = TRUE),
                     ifelse(cohort == 'org',
                            sum(all.daily.hosp$mental.stat == 'Delirious', na.rm = TRUE),
                            sum(all.daily.hosp$mental.stat.imp == 'Delirious', na.rm = TRUE))))),
         denom.all = ifelse(cohort == 'org', n.days.asmt, n.hosp.days),
         pct.del = round((nsub / denom.del)*100),
         pct.all = round((nsub / denom.all)*100),
         npct = ifelse(subtype == 'n.days', format(nsub, big.mark = ','),
                ifelse(!is.na(pct.del) & subtype == 'n.sedhypo',
                       paste0(pct.all, '% of all; ', pct.del, '% of hypoactive (', nsub, ')'),
                ifelse(!is.na(pct.del),
                       paste0(pct.all, '% of all; ', pct.del, '% of delirious (', nsub, ')'),
                       paste0(pct.all, '% (', nsub, ')'))))) %>%
  select(subtype, cohort, npct) %>%
  spread(key = cohort, value = npct) %>%
  mutate(rowlabel = c(paste0(space.6, 'Any hyperactive'),
                      paste0(space.6, 'Any hypoactive'),
                      paste0(space.6, 'Both hypo- and hyperactive'),
                      paste0(space.3, 'Any coma'), #'Any coma',
                      'Number of patient-days',
                      paste0(space.3, 'Any delirium'), #'Any delirium',
                      paste0(space.3, 'No delirium or coma'), #'No delirium or coma',
                      paste0(space.6, 'Hyperactive only'),
                      paste0(space.6, 'Hypoactive only'),
                      paste0(space.6, space.3, 'Hypoactive on sedation')),
         sortby = c(6, 4, 7, 2, 0, 3, 1, 9, 8, 5)) %>%
  arrange(sortby) %>%
  select(rowlabel, org, imp)

names(subtypes.by.day) <- c('', 'Recorded Data', 'Recorded + Imputed Data')

```

#### `r table_nums('describe_byday')`
Hypoactive delirium "on sedation" indicates that the patient had at least one CAM+ assessment on a
study day on which the total 24h dose of benzodiazepines and/or propofol was greater than 0. Due to
limitations of data collection, we cannot say for sure whether delirium occurred while the patient
was actually on sedatives.

```{r print_desc_day, results = 'asis'}
pandoc.table(subtypes.by.day,
             justify = c('left', 'right', 'right'), split.cells = Inf, split.tables = Inf)

```

```{r describe_subtypes_pt}
## -- Table for all *patients* (using imputed data) ------------------------------------------------
## Function to determine whether patient ever had condition in question
ever.had.this <- function(x, value = 'Yes'){
  factor(as.numeric(sum(x == value, na.rm = TRUE) > 0),
         levels = 0:1, labels = c('No', 'Yes'))
}

days.subtypes <- all.daily.hosp %>%
  group_by(id) %>%
  summarise(ever.hypodel.imp = ever.had.this(hypo.del.imp),
            days.hypodel.imp = sum(hypo.del.imp == 'Yes', na.rm = TRUE),
            ever.sedhypodel.imp = ever.had.this(sed.hypo.del.imp),
            days.sedhypodel.imp = sum(sed.hypo.del.imp == 'Yes', na.rm = TRUE),
            ever.hyperdel.imp = ever.had.this(hyper.del.imp),
            days.hyperdel.imp = sum(hyper.del.imp == 'Yes', na.rm = TRUE),
            ever.bothdel.imp = ever.had.this(mental.stat.subtype.imp,
                                             'Both hypo- and hyperactive delirium'),
            days.bothdel.imp =
              sum(mental.stat.subtype.imp == 'Both hypo- and hyperactive delirium', na.rm = TRUE),
            ever.onlyhypo.imp = ever.had.this(mental.stat.subtype.imp, 'Hypoactive delirium'),
            days.onlyhypo.imp = sum(mental.stat.subtype.imp == 'Hypoactive delirium', na.rm = TRUE),
            ever.onlyhyper.imp = ever.had.this(mental.stat.subtype.imp, 'Hyperactive delirium'),
            days.onlyhyper.imp =
              sum(mental.stat.subtype.imp == 'Hyperactive delirium', na.rm = TRUE)) %>%
  mutate(days.hypodel.exp = ifelse(days.hypodel.imp == 0, NA, days.hypodel.imp),
         days.sedhypodel.exp = ifelse(days.sedhypodel.imp == 0, NA, days.sedhypodel.imp),
         days.hyperdel.exp = ifelse(days.hyperdel.imp == 0, NA, days.hyperdel.imp),
         days.bothdel.exp = ifelse(days.bothdel.imp == 0, NA, days.bothdel.imp),
         days.onlyhypo.exp = ifelse(days.onlyhypo.imp == 0, NA, days.onlyhypo.imp),
         days.onlyhyper.exp = ifelse(days.onlyhyper.imp == 0, NA, days.onlyhyper.imp))

all.oneobs <- left_join(all.oneobs, days.subtypes, by = 'id')
all.oneobs <- upData(all.oneobs,
  labels = c(ever.hypodel.imp = 'Ever had hypoactive delirium',
             ever.sedhypodel.imp = 'Ever had hypoactive delirium on sedation',
             ever.hyperdel.imp = 'Ever had hyperactive delirium',
             ever.onlyhypo.imp = 'Ever had day with only hypoactive delirium',
             ever.onlyhyper.imp = 'Ever had day with only hyperactive delirium',
             ever.bothdel.imp = 'Ever had day with both hypo- and hyperactive delirium',
             days.hypodel.imp = 'Days of hypoactive delirium',
             days.sedhypodel.imp = 'Days of hypoactive delirium on sedation',
             days.hyperdel.imp = 'Days of hyperactive delirium',
             days.bothdel.imp = 'Days of both hypo- and hyperactive delirium',
             days.onlyhypo.imp = 'Days of only hypoactive delirium',
             days.onlyhyper.imp = 'Days of only hyperactive delirium',
             days.hypodel.exp = 'Days of hypoactive delirium among exposed',
             days.sedhypodel.exp = 'Days of hypoactive delirium on sedation among exposed',
             days.hyperdel.exp = 'Days of hyperactive delirium among exposed',
             days.bothdel.exp = 'Days of both hypo- and hyperactive delirium among exposed',
             days.onlyhypo.exp = 'Days of only hypoactive delirium among exposed',
             days.onlyhyper.exp = 'Days of only hyperactive delirium among exposed'))

all.oneobs.desc <- left_join(all.oneobs.desc, days.subtypes, by = 'id')
all.oneobs.desc <- upData(all.oneobs.desc,
  labels = c(ever.hypodel.imp = 'Ever had hypoactive delirium',
             ever.sedhypodel.imp = 'Ever had hypoactive delirium on sedation',
             ever.hyperdel.imp = 'Ever had hyperactive delirium',
             ever.onlyhypo.imp = 'Ever had day with only hypoactive delirium',
             ever.onlyhyper.imp = 'Ever had day with only hyperactive delirium',
             ever.bothdel.imp = 'Ever had day with both hypo- and hyperactive delirium',
             days.hypodel.imp = 'Days of hypoactive delirium',
             days.sedhypodel.imp = 'Days of hypoactive delirium on sedation',
             days.hyperdel.imp = 'Days of hyperactive delirium',
             days.bothdel.imp = 'Days of both hypo- and hyperactive delirium',
             days.onlyhypo.imp = 'Days of only hypoactive delirium',
             days.onlyhyper.imp = 'Days of only hyperactive delirium',
             days.hypodel.exp = 'Days of hypoactive delirium among exposed',
             days.sedhypodel.exp = 'Days of hypoactive delirium on sedation among exposed',
             days.hyperdel.exp = 'Days of hyperactive delirium among exposed',
             days.bothdel.exp = 'Days of both hypo- and hyperactive delirium among exposed',
             days.onlyhypo.exp = 'Days of only hypoactive delirium among exposed',
             days.onlyhyper.exp = 'Days of only hyperactive delirium among exposed'))

mental.status.table <- summaryM(coma.s.imp + del.s.imp +
                                  ever.hypodel.imp + days.hypodel.imp + days.hypodel.exp +
                                  ever.sedhypodel.imp + days.sedhypodel.imp + days.sedhypodel.exp +
                                  ever.hyperdel.imp + days.hyperdel.imp + days.hyperdel.exp +
                                  ever.bothdel.imp + days.bothdel.imp + days.bothdel.exp +
                                  ever.onlyhypo.imp + days.onlyhypo.imp + days.onlyhypo.exp +
                                  ever.onlyhyper.imp + days.onlyhyper.imp +
                                  days.onlyhyper.exp ~ ptgroup,
                                data = all.oneobs.desc, continuous = 5)

## Save elements of all.oneobs, all.oneobs.desc to Rdata file for Shawn
keep.names.oneobs <- grep('date|posix', names(all.oneobs), invert = TRUE)
keep.names.oneobs.desc <- grep('date|posix', names(all.oneobs.desc), invert = TRUE)
shawn.oneobs <- all.oneobs[,keep.names.oneobs]
shawn.oneobs.desc <- all.oneobs.desc[,keep.names.oneobs.desc]
save(shawn.oneobs, shawn.oneobs.desc, ltpts.either, file = 'shawn_summaryM.Rdata')

```

#### `r table_nums('describe_bypt')`
```{r print_desc_pt, results = 'asis'}
html(mental.status.table, rmarkdown = TRUE, prmsd = TRUE, brmsd = TRUE,
     what = '%', npct = 'both', digits = 2, long = TRUE, caption = '', prn = FALSE,
     middle.bold = TRUE, msdsize = markupSpecs$html$smaller)

```

# In-Hospital Mortality
We examined the association of the two motoric subtypes of delirium, and their potential
modification of each other's effect, on in-hospital mortality up to 30 days after study enrollment
among both the entire cohort of enrolled patients.

## Model Choice and Covariates
We used a time-varying Cox proportional hazards model in order to avoid immortal time bias, which
occurs in our case when a patient had limited opportunity to experience either subtype of delirium
(along with other covariates) because they had already died. Each ICU day is treated as a separate
record; values from days of ICU discharge are carried forward either to the next ICU admission or
until death or censoring. We included the following covariates:

* Primary exposures
    * Hyperactive delirium today (yes/no)
    * Hypoactive delirium today (yes/no)
    * Interaction between hypoactive and hyperactive delirium today
* Baseline covariates
    * Age at enrollment
    * Years of education
    * Charlson comorbidity index
    * IQCODE
* Daily ICU covariates
    * Severe sepsis today (yes/no)
    * Coma today (yes/no)
    * Daily modified SOFA (no CNS component, as this is better reflected by coma and delirium)
    * 24h dose of the following medications, all cube root transformed:
        * Benzodiazepines (midazolam equivalents)
        * Opioids (fentanyl equivalents)
        * Propofol
        * Dexmedetomidine
        * Haloperidol
        
All continuous covariates will be allowed to have a nonlinear association with hazard of death,
using restricted cubic splines, if event rates and covariate distribution allows. (For example, there are so many zero doses of haloperidol and dexmedetomidine that it is not feasible to use
splines for these variables.) Degrees of freedom for each covariate will be noted in the model
results table.

```{r tv_both_datamgmt}
## -- Create data set for time-varying Cox model, 12m endpoint -------------------------------------
## Sets of covariates
base.covars <- c('age.enroll', 'edu', 'charlson.score', 'iqcode.score.e')
daily.icu.covars <- c('hyper.del.imp', 'hypo.del.imp', 'coma.today.imp', 'sevsepsis.l24',
                      'daily.sofa.mod.locf', 'tot.benz.cube', 'tot.op.cube', 'tot.prop.cube',
                      'tot.dex.cube', 'tot.hal.cube')

## Get data set of all ICU days with daily covariates needed for models
tv.daily.icu <- filter(all.daily, !is.na(icu.day) & icu.day == 'ICU') %>%
  select(id, study.day, one_of(daily.icu.covars))

## Named vector of variable labels to shorten in time-varying models
tv.shortlabs <- c("hypo.del.imp" = "Hypoactive", "hyper.del.imp" = "Hyperactive")

```

```{r death_inhosp_all_datamgmt}
## -- Data management for in-hospital mortality model including all patients -----------------------
## -- Create count process data set ----------------------------------------------------------------
data.death.inhosp <- timevarying.data(org.data = tv.daily.icu,
                                      time.var = 'days.deathlast.inhosp.s',
                                      event.var = 'died.ever.30',
                                      event.string = 'Died during first 30 days',
                                      data.set = all.oneobs) %>%
  left_join(select(all.oneobs, id, one_of(base.covars)), by = 'id')

## For some reason, factor labels don't transfer
data.death.inhosp <- upData(data.death.inhosp,
  labels = c(coma.today.imp = 'Coma today (imputed)',
             hypo.del.imp = 'Hypoactive delirium today (imputed)',
             hyper.del.imp = 'Hyperactive delirium today (imputed)'))

## -- Describe missingness -------------------------------------------------------------------------
## Patients with no days of ICU data
pts.miss.death.inhosp <- setdiff(subset(all.pts, include.main)$id, unique(data.death.inhosp$id))
pttext.miss.death.inhosp <- ifelse(length(pts.miss.death.inhosp) == 0,
                                   paste('All', n.included,
                                         'patients with usable data were included in this analysis.'),
                                   paste('Among all', n.included, 'patients with usable data,',
                                         length(pts.miss.death.inhosp),
                                         'had no daily ICU data due to death or discharge on the same day as enrollment and were excluded from this analysis.'))

## Missingness among covariates
base.miss.death.inhosp <- map_chr(base.covars, covars.missing,
                                  df = data.death.inhosp, covar.list = base.covars) %>%
  paste.covars.missing()

daily.miss.death.inhosp <- map_chr(daily.icu.covars, covars.missing,
                                   df = data.death.inhosp,
                                   covar.list = daily.icu.covars) %>%
  paste.covars.missing()

## -- Create string describing miss. among covariates in in-hospital-mortality model, all pts ------
any.miss.death.inhosp <- !(base.miss.death.inhosp == '' & daily.miss.death.inhosp == '')
if(!any.miss.death.inhosp){
  miss.death.inhosp <- 'There was no missingness in any covariates used in the model.'
} else{
  if(base.miss.death.inhosp != ''){
    text.base.miss.death.inhosp <- paste('among all unique patients -', base.miss.death.inhosp)
  } else{
    text.base.miss.death.inhosp <- ''
  }
  
  if(daily.miss.death.inhosp != ''){
    text.daily.miss.death.inhosp <- paste('among all patient-days -', daily.miss.death.inhosp)
  } else{
    text.daily.miss.death.inhosp <- ''
  }
  miss.death.inhosp <- paste0("Missingness among model covariates was as follows: ",
                              trim.spaces(paste(text.base.miss.death.inhosp,
                                                text.daily.miss.death.inhosp,
                                                collapse = '; ')),
                              '.')
}

```

## Missingness
`r pttext.miss.death.inhosp` `r miss.death.inhosp`

Since there was so little missingness and multiple imputation with count process data is not
trivial, we included only complete case records in this analysis.

```{r death_inhosp_model}
## Set datadist
datadist.death.inhosp <- datadist(data.death.inhosp)
options(datadist = 'datadist.death.inhosp')

## Create Surv object for outcome
Surv.death.inhosp <- with(data.death.inhosp, {
  Surv(time = start.day, time2 = stop.day, event = as.numeric(died)) })

## Fit model
model.death.inhosp <- cph(Surv.death.inhosp ~ rcs(age.enroll, 3) + edu + iqcode.score.e +
                            rcs(charlson.score, 3) + rcs(daily.sofa.mod.locf, 3) +
                            rcs(tot.benz.cube, 3) + rcs(tot.op.cube, 3) + rcs(tot.prop.cube, 3) +
                            tot.dex.cube + tot.hal.cube + coma.today.imp +
                            hypo.del.imp*hyper.del.imp,
                          data = data.death.inhosp,
                          x = TRUE, y = TRUE)

```

## Model Assumptions
We visually checked the assumptions of the Cox proportional hazards model by examining residuals
over time. The assumption was met satisfactorily for each beta coefficient.

```{r death_inhosp_assumptions, results = 'asis'}
## -- Check proportional hazard assumption ---------------------------------------------------------
zph.death.inhosp <- cox.zph(model.death.inhosp, transform = 'log')

par(mfrow = c(1, 3))
plot(zph.death.inhosp, col = 'red', lwd = 2)
abline(v = 0, lty = 2, col = 'gray')
par(mfrow = c(1, 1))

```

## Overall Model Results
**General summary of motoric subtypes:** Having either motoric subtype of delirium on a given day
seems to have no relationship with the hazard of in-hospital death in the 30 days following study
enrollment when looking at the entire cohort of `r length(unique(data.death.inhosp$id))` patients
with usable data. There is no significant interaction between the two motoric subtypes for this
outcome.

Results for all model covariates, adjusted to the median or mode of all other covariates, are
presented in `r table_nums('results_death_inhosp', display = 'cite')`; due to the presence of
interaction terms, it is important to note that in the table, hypoactive delirium is adjusted to
`r as.character(datadist.death.inhosp$limits['Adjust to', 'hypo.del.imp'])` and hyperactive delirium
is adjusted to `r as.character(datadist.death.inhosp$limits['Adjust to', 'hyper.del.imp'])`. More
detailed hazard ratios for the two motoric subtypes are shown in `r figure_nums('subtypehrs_death_inhosp', display = 'cite')`.

*Note on `r table_nums('results_death_inhosp', display = 'cite')`*: For continuous covariates,
hazard ratios will be different depending on the points of comparison chosen, especially for
covariates allowed to have a nonlinear relationship with the hazard of death (indicated by df > 1).
We have chosen to compare the 75th percentile and the 25th percentile by default, since this is
often a clinically relevant comparison. For variables with very skewed distributions, where those
two percentiles are the same (eg, lots of zero drug doses), the points of comparison may be the
maximum and minimum instead.

```{r death_inhosp_results}
## Data frame of model results
results.death.inhosp <- model.results(model.death.inhosp,
                                      data.set = data.death.inhosp,
                                      short.label = tv.shortlabs,
                                      print.format = 'plain',
                                      add.stats = c("Model L.R.", "R2")) %>%
  ital.rows()

names(results.death.inhosp) <- c('Covariate', 'Reference\n(usu. 25th %ile)',
                                 'Comparison\n(usu. 75th %ile)', 'Hazard ratio\n(95% CI)',
                                 'X^2^', 'df', 'P')

```

```{r death_inhosp_results_print, results = 'asis'}
pandoc.table(results.death.inhosp,
             justify = c('left', rep('right', ncol(results.death.inhosp) - 1)),
             split.cells = Inf, split.tables = Inf, keep.line.breaks = TRUE)

```

#### `r figure_nums('subtypehrs_death_inhosp')`
```{r death_inhosp_plot}
## -- Calculate HRs for each motoric subtype at each level of the other subtype --------------------
tv.hrs.arglist <- list('est.var' = c(rep('hypo.del.imp', 2), rep('hyper.del.imp', 2)),
                       'int.var' = c(rep('hyper.del.imp', 2), rep('hypo.del.imp', 2)),
                       'int.adjust' = rep(c('No', 'Yes'), 2))

hrs.death.inhosp <- pmap(tv.hrs.arglist,
                         .f = estimate.with.interaction.rms,
                         model.obj = 'model.death.inhosp') %>%
  bind_rows() %>%
  mutate(var.main.label = paste(gsub(' \\(imputed\\)', '', label(data.death.inhosp[,var.main])),
                                'vs. none'),
         var.int.label = label(data.death.inhosp[,var.int]),
         adjusted.to = paste(gsub(' .+', '', var.int.label), adjust.int, sep = ' = '))

## Rename some variables since they'll show up in tooltips
names(hrs.death.inhosp) <- gsub('effect', 'hr', names(hrs.death.inhosp))

subtype.plot.death.inhosp <- ggplot(data = hrs.death.inhosp,
                                    aes(x = adjusted.to, y = hr)) +
  facet_wrap(~ var.main.label, ncol = 1, scales = 'free_y') +
  geom_pointrange(aes(ymin = lowercl, ymax = uppercl), colour = nate.navy) +
  geom_hline(yintercept = 1, linetype = 'dotted', colour = 'grey50') +
  scale_x_discrete(name = '') +
  scale_y_continuous(name = '', labels = comma) +
  coord_flip() +
  theme(axis.ticks.y = element_blank())

```

```{r death_inhosp_plot_print, results = 'asis', fig.width=8, fig.height=5}
subtype.plot.death.inhosp %>%
  ggplotly(tooltips = c('y', 'ymin', 'ymax', 'x')) %>%
  layout(xaxis = list(title = 'Hazard Ratio (95% Confidence Interval)'),
         margin = list(b = 40))

```

# 12-Month Mortality
We examined the association of the two motoric subtypes of delirium, and their potential
modification of each other's effect, on mortality up to twelve months after study enrollment among
both the entire cohort of enrolled patients and among patients who survived the hospital stay.

## All Patients
### Model Choice and Covariates
When looking at the entire cohort, we used a time-varying Cox proportional hazards model in order to
avoid immortal time bias, which occurs in our case when a patient had limited opportunity to
experience either subtype of delirium (along with other covariates) because they had already died.
Each ICU day is treated as a separate record; values from days of ICU discharge are carried forward
either to the next ICU admission or until death or censoring. We included the following covariates:

* Primary exposures
    * Hyperactive delirium today (yes/no)
    * Hypoactive delirium today (yes/no)
    * Interaction between hypoactive and hyperactive delirium today
* Baseline covariates
    * Age at enrollment
    * Years of education
    * Charlson comorbidity index
    * IQCODE
* Daily ICU covariates
    * Severe sepsis today (yes/no)
    * Coma today (yes/no)
    * Daily modified SOFA (no CNS component, as this is better reflected by coma and delirium)
    * 24h dose of the following medications, all cube root transformed:
        * Benzodiazepines (midazolam equivalents)
        * Opioids (fentanyl equivalents)
        * Propofol
        * Dexmedetomidine
        * Haloperidol
        
All continuous covariates will be allowed to have a nonlinear association with hazard of death,
using restricted cubic splines, if event rates and covariate distribution allows. (For example, there are so many zero doses of haloperidol and dexmedetomidine that it is not feasible to use
splines for these variables.) Degrees of freedom for each covariate will be noted in the model
results table.

```{r death_12_all_datamgmt}
## -- Data management for 12-month mortality model including all patients --------------------------
## -- Create count process data set ----------------------------------------------------------------
data.death.12.all <- timevarying.data(org.data = tv.daily.icu,
                                      time.var = 'days.deathlast.365',
                                      event.var = 'died.ever.365',
                                      event.string = 'Died during first 365 days',
                                      data.set = all.oneobs) %>%
  left_join(select(all.oneobs, id, one_of(base.covars)), by = 'id')

## For some reason, factor labels don't transfer
data.death.12.all <- upData(data.death.12.all,
  labels = c(coma.today.imp = 'Coma today (imputed)',
             hypo.del.imp = 'Hypoactive delirium today (imputed)',
             hyper.del.imp = 'Hyperactive delirium today (imputed)'))

## -- Describe missingness -------------------------------------------------------------------------
## Patients with no days of ICU data
pts.miss.death.12.all <- setdiff(subset(all.pts, include.main)$id, unique(data.death.12.all$id))
pttext.miss.death.12.all <- ifelse(length(pts.miss.death.12.all) == 0,
                                   paste('All', n.included,
                                         'patients with usable data were included in this analysis.'),
                                   paste('Among all', n.included, 'patients with usable data,',
                                         length(pts.miss.death.12.all),
                                         'had no daily ICU data due to death or discharge on the same day as enrollment and were excluded from this analysis.'))

## Missingness among covariates
base.miss.death.12.all <- map_chr(base.covars, covars.missing,
                                  df = data.death.12.all, covar.list = base.covars) %>%
  paste.covars.missing()

daily.miss.death.12.all <- map_chr(daily.icu.covars, covars.missing,
                                   df = data.death.12.all, covar.list = daily.icu.covars) %>%
  paste.covars.missing()

## -- Create string describing missingness among covariates in 12m-mortality model, all pts -------
any.miss.death.12.all <- !(base.miss.death.12.all == '' & daily.miss.death.12.all == '')
if(!any.miss.death.12.all){
  miss.death.12.all <- 'There was no missingness in any covariates used in the model.'
} else{
  if(base.miss.death.12.all != ''){
    text.base.miss.death.12.all <- paste('among all unique patients -', base.miss.death.12.all)
  } else{
    text.base.miss.death.12.all <- ''
  }
  
  if(daily.miss.death.12.all != ''){
    text.daily.miss.death.12.all <- paste('among all patient-days -', daily.miss.death.12.all)
  } else{
    text.daily.miss.death.12.all <- ''
  }
  miss.death.12.all <- paste0("Missingness among model covariates was as follows: ",
                              trim.spaces(paste(text.base.miss.death.12.all,
                                                text.daily.miss.death.12.all,
                                                collapse = '; ')),
                              '.')
}

```

### Missingness
`r pttext.miss.death.12.all` `r miss.death.12.all`

Since there was so little missingness and multiple imputation with count process data is not
trivial, we included only complete case records in this analysis.

```{r death_12_all_model}
## Set datadist
datadist.death.12.all <- datadist(data.death.12.all)
options(datadist = 'datadist.death.12.all')

## Create Surv object for outcome
Surv.death.12.all <- with(data.death.12.all, {
  Surv(time = start.day, time2 = stop.day, event = as.numeric(died)) })

## Fit model
model.death.12.all <- cph(Surv.death.12.all ~ rcs(age.enroll, 3) + edu + iqcode.score.e +
                            rcs(charlson.score, 3) + rcs(daily.sofa.mod.locf, 3) +
                            rcs(tot.benz.cube, 3) + rcs(tot.op.cube, 3) + rcs(tot.prop.cube, 3) +
                            tot.dex.cube + tot.hal.cube + coma.today.imp +
                            hypo.del.imp*hyper.del.imp,
                          data = data.death.12.all,
                          x = TRUE, y = TRUE)

```

### Model Assumptions
We visually checked the assumptions of the Cox proportional hazards model by examining residuals
over time. The assumption was met satisfactorily for each beta coefficient.

```{r death_12_all_assumptions, results = 'asis'}
## -- Check proportional hazard assumption ---------------------------------------------------------
zph.death.12.all <- cox.zph(model.death.12.all, transform = 'log')

par(mfrow = c(1, 3))
plot(zph.death.12.all, col = 'red', lwd = 2)
abline(v = 0, lty = 2, col = 'gray')
par(mfrow = c(1, 1))

```

### Overall Model Results
**General summary of motoric subtypes:** Having either motoric subtype of delirium on a given day
seems to have no relationship with the hazard of death in the 12 months following study enrollment
when looking at the entire cohort of `r length(unique(data.death.12.all$id))` patients with usable
data. There is no significant interaction between the two motoric subtypes for this outcome.

Results for all model covariates, adjusted to the median or mode of all other covariates, are
presented in `r table_nums('results_death_12_all', display = 'cite')`; due to the presence of
interaction terms, it is important to note that in the table, hypoactive delirium is adjusted to
`r as.character(datadist.death.12.all$limits['Adjust to', 'hypo.del.imp'])` and hyperactive delirium
is adjusted to `r as.character(datadist.death.12.all$limits['Adjust to', 'hyper.del.imp'])`. More
detailed hazard ratios for the two motoric subtypes are shown in `r figure_nums('subtypehrs_death_12_all', display = 'cite')`.

*Note on `r table_nums('results_death_12_all', display = 'cite')`*: For continuous covariates,
hazard ratios will be different depending on the points of comparison chosen, especially for
covariates allowed to have a nonlinear relationship with the hazard of death (indicated by df > 1).
We have chosen to compare the 75th percentile and the 25th percentile by default, since this is
often a clinically relevant comparison. For variables with very skewed distributions, where those
two percentiles are the same (eg, lots of zero drug doses), the points of comparison may be the
maximum and minimum instead.

```{r death_12_all_results}
## Data frame of model results
results.death.12.all <- model.results(model.death.12.all,
                                      data.set = data.death.12.all,
                                      short.label = tv.shortlabs,
                                      print.format = 'plain',
                                      add.stats = c("Model L.R.", "R2")) %>%
  ital.rows()

names(results.death.12.all) <- c('Covariate', 'Reference\n(usu. 25th %ile)',
                                 'Comparison\n(usu. 75th %ile)', 'Hazard ratio\n(95% CI)',
                                 'X^2^', 'df', 'P')

```

```{r death_12_all_results_print, results = 'asis'}
pandoc.table(results.death.12.all,
             justify = c('left', rep('right', ncol(results.death.12.all) - 1)),
             split.cells = Inf, split.tables = Inf, keep.line.breaks = TRUE)

```

#### `r figure_nums('subtypehrs_death_12_all')`
```{r death_12_all_plot}
## -- Calculate HRs for each motoric subtype at each level of the other subtype --------------------
hrs.death.12.all <- pmap(tv.hrs.arglist,
                         .f = estimate.with.interaction.rms,
                         model.obj = 'model.death.12.all') %>%
  bind_rows() %>%
  mutate(var.main.label = paste(gsub(' \\(imputed\\)', '', label(data.death.12.all[,var.main])),
                                'vs. none'),
         var.int.label = label(data.death.12.all[,var.int]),
         adjusted.to = paste(gsub(' .+', '', var.int.label), adjust.int, sep = ' = '))

## Rename some variables since they'll show up in tooltips
names(hrs.death.12.all) <- gsub('effect', 'hr', names(hrs.death.12.all))

subtype.plot.death.12.all <- ggplot(data = hrs.death.12.all,
                                    aes(x = adjusted.to, y = hr)) +
  facet_wrap(~ var.main.label, ncol = 1, scales = 'free_y') +
  geom_pointrange(aes(ymin = lowercl, ymax = uppercl), colour = nate.navy) +
  geom_hline(yintercept = 1, linetype = 'dotted', colour = 'grey50') +
  scale_x_discrete(name = '') +
  scale_y_continuous(name = '',
                     breaks = seq(0, ceiling(max(hrs.death.12.all$uppercl)), by = 1)) +
  coord_flip() +
  theme(axis.ticks.y = element_blank())

```

```{r death_12_all_plot_print, results = 'asis', fig.width=8, fig.height=5}
subtype.plot.death.12.all %>%
  ggplotly(tooltips = c('y', 'ymin', 'ymax', 'x')) %>%
  layout(xaxis = list(title = 'Hazard Ratio (95% Confidence Interval)'),
         margin = list(b = 40))

```

## Hospital Survivors Only
We also examined the association of both motoric subtypes of delirium with long-term mortality only
among patients who survived their hospital stay: Given that the patient was well enough to be
discharged alive, did the amounts of either/both delirium subtypes have any association with
mortality in the remainder of the 12 months after study enrollment?

### Model Choice and Covariates
All our covariates were either measured at baseline or are summary variables reflecting the entire
ICU stay, and only among patients who survived their entire hospitalization; therefore, there is no
possibility for immortal time bias and no need for a time-varying model. Rather, we use a "regular"
Cox proportional hazards model, including the following covariates:

* Primary exposures
    * Days of hyperactive delirium during the hospitalization
    * Days of hypoactive delirium during the hospitalization
    * Interaction between days of hypoactive and hyperactive delirium
* Baseline covariates
    * Age at enrollment
    * Years of education
    * Charlson comorbidity index
    * IQCODE
* ICU/hospitalization covariates
    * Days of severe sepsis
    * Days of coma
    * Mean daily modified SOFA (no CNS component, as this is better reflected by coma and delirium)
    * Mean 24h dose in the ICU of the following medications, all cube root transformed:
        * Benzodiazepines (midazolam equivalents)
        * Opioids (fentanyl equivalents)
        * Propofol
        * Dexmedetomidine
        * Haloperidol
        
All continuous covariates will be allowed to have a nonlinear association with hazard of death,
using restricted cubic splines, if event rates and covariate distribution allows. (For example, there are so many zero doses of haloperidol and dexmedetomidine that it is not feasible to use
splines for these variables.) Degrees of freedom for each covariate will be noted in the model
results table.

```{r death_12_surv_datamgmt}
## -- Data management for 12-month mortality model including only survivors ------------------------
hosp.covars <- c('days.hyperdel.imp', 'days.hypodel.imp', 'icudays.sevseptic.s', 'coma.s.imp',
                 'mean.modsofa.icu', 'mean.benz.cube', 'mean.op.cube', 'mean.prop.cube',
                 'mean.dex.cube', 'mean.hal.cube')

data.death.12.surv <- all.oneobs %>%
  filter(id %in% pts.survived) %>%
  select(id, died.ever.365, days.deathlast.365, one_of(base.covars), one_of(hosp.covars))

## -- Describe missingness -------------------------------------------------------------------------
miss.death.12.surv <- map_chr(c(base.covars, hosp.covars), covars.missing,
                              df = data.death.12.surv, covar.list = c(base.covars, hosp.covars)) %>%
  paste.covars.missing()

pts.miss.death.12.surv <- sum(!complete.cases(data.death.12.surv))

## -- Create string describing missingness among covariates in 12m-mortality model, all pts -------
any.miss.death.12.surv <- !(miss.death.12.all == '')
if(!any.miss.death.12.surv){
  miss.death.12.surv <- 'there was no missingness in any covariates used in the model.'
} else{
  miss.death.12.surv <- paste('missingness among covariates was as follows:', miss.death.12.surv)
}

```

### Missingness
Among the `r length(pts.survived)` hospital survivors included in analysis, `r miss.death.12.surv`.
This missingness occurred in `r pts.miss.death.12.surv` unique patients (`r round((pts.miss.death.12.surv / n.surv.inhosp)*100)`% of hospital survivors).

Since there was so little missingness, we included only the `r n.surv.inhosp - pts.miss.death.12.surv` complete case records in this analysis.

```{r death_12_surv_model}
## Set datadist
datadist.death.12.surv <- datadist(data.death.12.surv)
options(datadist = 'datadist.death.12.surv')

## Create Surv object for outcome
Surv.death.12.surv <- with(data.death.12.surv, {
  Surv(time = days.deathlast.365, event = as.numeric(died.ever.365)) })

## Fit model
model.death.12.surv <- cph(Surv.death.12.surv ~ rcs(age.enroll, 3) + edu + iqcode.score.e +
                             rcs(charlson.score, 3) + rcs(mean.modsofa.icu, 3) +
                             rcs(mean.benz.cube, 3) + rcs(mean.op.cube, 3) +
                             rcs(mean.prop.cube, 3) + mean.dex.cube + mean.hal.cube +
                             rcs(coma.s.imp, 3) + rcs(days.hypodel.imp, 3)*days.hyperdel.imp,
                           data = data.death.12.surv,
                           x = TRUE, y = TRUE)

```

### Model Assumptions
We visually checked the assumptions of the Cox proportional hazards model by examining residuals
over time. The assumption was met satisfactorily for each beta coefficient.

```{r death_12_surv_assumptions, results = 'asis'}
## -- Check proportional hazard assumption ---------------------------------------------------------
zph.death.12.surv <- cox.zph(model.death.12.surv, transform = 'log')

par(mfrow = c(1, 3))
plot(zph.death.12.surv, col = 'red', lwd = 2)
abline(v = 0, lty = 2, col = 'gray')
par(mfrow = c(1, 1))

```

### Overall Model Results
**General summary of motoric subtypes:** Having either motoric subtype of delirium on a given day
seems to have no relationship with the hazard of death in the 12 months following study enrollment
when looking at the cohort of `r n.surv.inhosp - pts.miss.death.12.surv` patients . There is no
significant interaction between the two motoric subtypes for this outcome.

Results for all model covariates, adjusted to the median or mode of all other covariates, are
presented in `r table_nums('results_death_12_surv', display = 'cite')`; due to the presence of
interaction terms, it is important to note that in the table, hypoactive delirium is adjusted to
`r as.character(datadist.death.12.surv$limits['Adjust to', 'days.hypodel.imp'])` days, and hyperactive delirium is adjusted to `r as.character(datadist.death.12.surv$limits['Adjust to', 'days.hyperdel.imp'])` days. More detailed hazard ratios for the two motoric subtypes are shown in `r figure_nums('subtypehrs_death_12_surv', display = 'cite')`.

*Note on `r table_nums('results_death_12_surv', display = 'cite')`*: For continuous covariates,
hazard ratios will be different depending on the points of comparison chosen, especially for
covariates allowed to have a nonlinear relationship with the hazard of death (indicated by df > 1).
We have chosen to compare the 75th percentile and the 25th percentile by default, since this is
often a clinically relevant comparison. For variables with very skewed distributions, where those
two percentiles are the same (eg, lots of zero drug doses), the points of comparison may be the
maximum and minimum instead.

```{r death_12_surv_results}
## Shorten labels for interaction terms
lt.shortlabs <- c('days.hypodel.imp' = 'Days hypoactive', 'days.hyperdel.imp' = 'Days hyperactive')

## Data frame of model results
results.death.12.surv <- model.results(model.death.12.surv,
                                       data.set = data.death.12.surv,
                                       short.label = lt.shortlabs,
                                       print.format = 'plain',
                                       add.stats = c("Model L.R.", "R2")) %>%
  ital.rows()

names(results.death.12.surv) <- c('Covariate', 'Reference\n(usu. 25th %ile)',
                                 'Comparison\n(usu. 75th %ile)', 'Hazard ratio\n(95% CI)',
                                 'X^2^', 'df', 'P')

```

```{r death_12_surv_results_print, results = 'asis'}
pandoc.table(results.death.12.surv,
             justify = c('left', rep('right', ncol(results.death.12.surv) - 1)),
             split.cells = c(55, rep(Inf, ncol(results.death.12.surv) - 1)),
             split.tables = Inf, keep.line.breaks = TRUE)

```

#### `r figure_nums('subtypehrs_death_12_surv')`
```{r death_12_surv_plot}
## -- Calculate HRs for each motoric subtype at each level of the other subtype --------------------
## Want to adjust to unique values of 0, 25th, 50th, 75th, 90th %iles
adjto.probs <- c(0, 0.25, 0.5, 0.75, 0.90)
quants.hypodel.surv <- unique(quantile(data.death.12.surv$days.hypodel.imp, probs = adjto.probs))
quants.hyperdel.surv <- unique(quantile(data.death.12.surv$days.hyperdel.imp, probs = adjto.probs))

## Get datadist defaults for days of hypoactive and hyperactive delirium;
## if not explicitly specified, summary.rms() thinks days.hyperdel.imp is a factor...?
## Defaults for days.hyperdel.imp are min and max. Use 0 and 90th %ile instead.
lowhigh.hypo.surv <- c(datadist.death.12.surv$limits['Low:effect', 'days.hypodel.imp'],
                       datadist.death.12.surv$limits['High:effect', 'days.hypodel.imp'])
lowhigh.hyper.surv <- c(0,
                        quantile(data.death.12.surv$days.hyperdel.imp, probs = 0.9, na.rm = TRUE))

surv.hrs.arglist <- list(est.var = c(rep('days.hypodel.imp', length(quants.hyperdel.surv)),
                                     rep('days.hyperdel.imp', length(quants.hypodel.surv))),
                         est.vals = c(replicate(length(quants.hyperdel.surv),
                                                lowhigh.hypo.surv, simplify = FALSE),
                                      replicate(length(quants.hypodel.surv),
                                                lowhigh.hyper.surv, simplify = FALSE)),
                         int.var = c(rep('days.hyperdel.imp', length(quants.hyperdel.surv)),
                                     rep('days.hypodel.imp', length(quants.hypodel.surv))),
                         int.adjust = c(quants.hyperdel.surv, quants.hypodel.surv))

hrs.death.12.surv <- pmap(surv.hrs.arglist,
                          .f = estimate.with.interaction.rms,
                          model.obj = 'model.death.12.surv') %>%
  bind_rows() %>%
  mutate(var.main.label = paste(comp.level, 'vs.', ref.level,
                                tools::toTitleCase(label(data.death.12.surv[,var.main]))),
         var.int.label = label(data.death.12.surv[,var.int]),
         adjusted.to = factor(1:n(),
                              labels = paste(gsub(' delirium', '', gsub('of ', '', var.int.label)),
                                             adjust.int, sep = ' = ')))

## Rename some variables since they'll show up in tooltips
names(hrs.death.12.surv) <- gsub('effect', 'hr', names(hrs.death.12.surv))

subtype.plot.death.12.surv <- ggplot(data = hrs.death.12.surv,
                                     aes(x = adjusted.to, y = hr)) +
  facet_wrap(~ var.main.label, ncol = 1, scales = 'free_y') +
  geom_pointrange(aes(ymin = lowercl, ymax = uppercl), colour = nate.navy) +
  geom_hline(yintercept = 1, linetype = 'dotted', colour = 'grey50') +
  scale_x_discrete(name = '') +
  scale_y_continuous(name = '', labels = comma) +
  coord_flip() +
  theme(axis.ticks.y = element_blank())

```

```{r death_12_surv_plot_print, results = 'asis', fig.width=8, fig.height=7}
subtype.plot.death.12.surv %>%
  ggplotly(tooltips = c('y', 'ymin', 'ymax', 'x')) %>%
  layout(xaxis = list(title = 'Hazard Ratio (95% Confidence Interval)'),
         margin = list(b = 40))

```

# Missingness for Cognitive Outcomes

Missingness in the case of our long-term cognitive outcomes is very likely informative: patients who
are more likely to do worse on cognitive testing are very possibly those most likely to not be
tested at all, due to being too tired or sick to complete the assessment, re-hospitalizations, etc.
In order to reduce bias from this missingness, we will use multiple imputation for all covariates
and all cognitive outcomes, including all patients with at least partial cognitive testing at a
given time point. The amounts of missingness for each time point, covariate and outcome are shown in `r table_nums('cognitive_missing', display = 'cite')`. (Variables not shown are completely present.)

```{r cognitive_datamgmt}
## -- Create data sets for 3m, 12m outcomes --------------------------------------------------------
cog.outcome.pref <- c('rbans.global.score', 'trail.b.tscore')
cog.outcomes.3 <- paste0(cog.outcome.pref, '.3')
cog.outcomes.12 <- paste0(cog.outcome.pref, '.12')

data.cog.3 <- all.oneobs %>%
  filter(id %in% ltpts.3m) %>%
  select(id, one_of(cog.outcomes.3), one_of(cog.outcomes.12),
         one_of(base.covars), one_of(hosp.covars))

data.cog.12 <- all.oneobs %>%
  filter(id %in% ltpts.12m) %>%
  select(id, one_of(cog.outcomes.3), one_of(cog.outcomes.12),
         one_of(base.covars), one_of(hosp.covars))

## -- Set datadist, using patients with data at either/both time points ----------------------------
datadist.cog <- datadist(all.oneobs[all.oneobs$id %in% ltpts.either,
                                    c(cog.outcomes.3, cog.outcomes.12, base.covars, hosp.covars)])
options(datadist = 'datadist.cog')

## -- Shorten variable labels in data.cog.3 (we'll use this for model.results()) -------------------
data.cog.3 <- upData(data.cog.3,
  labels = c(coma.s.imp = 'Days of coma',
             icudays.sevseptic.s = 'Days of severe sepsis',
             iqcode.score.e = 'IQCODE',
             mean.benz.cube = 'Mean 24h benzos, cube root',
             mean.op.cube = 'Mean 24h opioids, cube root',
             mean.prop.cube = 'Mean 24h propofol, cube root',
             mean.dex.cube = 'Mean 24h dex, cube root',
             mean.hal.cube = 'Mean 24h haldol, cube root',
             mean.modsofa.icu = 'Mean modified SOFA'))

```

```{r cognitive_missing}
cog.variables.3 <- c(cog.outcomes.3, base.covars, hosp.covars)
cog.variables.12 <- c(cog.outcomes.12, base.covars, hosp.covars)

miss.cog.3 <- map_chr(cog.variables.3, covars.missing,
                      df = data.cog.3, covar.list = cog.variables.3)
miss.cog.12 <- map_chr(cog.variables.12, covars.missing,
                       df = data.cog.12, covar.list = cog.variables.12)

miss.cog <- data.frame(variable = map_chr(cog.variables.3, ~ label(data.cog.3[,.])),
                       miss.3 = miss.cog.3,
                       miss.12 = miss.cog.12) %>%
  filter(!is.na(miss.3) | !is.na(miss.12)) %>%
  mutate(variable = gsub(' on| during.*', '', gsub(',.*$', '', variable)),
         miss.3 = ifelse(is.na(miss.3), '0 (0%)', gsub('.*:', '', miss.3)),
         miss.12 = ifelse(is.na(miss.12), '0 (0%)', gsub('.*:', '', miss.12)))

names(miss.cog) <- c('Variable',
                     paste('3 Months\\\nN =', length(ltpts.3m)),
                     paste('12 Months\\\nN =', length(ltpts.12m)))

```

#### `r table_nums('cognitive_missing')`
```{r print_cognitive_missing, results = 'asis'}
pandoc.table(miss.cog,
             justify = c('left', 'right', 'right'), split.cells = Inf, split.table = Inf,
             keep.line.breaks = TRUE)

```

The vast majority of missingness is from the outcome variables themselves. To handle this and reduce
bias resulting from a complete case analysis, we will use multiple imputation (predictive mean
matching) in all cognitive outcome models.

```{r cognitive_imputation}
## -- Create aregImpute() objects for 3, 12m followup data sets ------------------------------------
areg.formula <- as.formula("~ rbans.global.score.3 + rbans.global.score.12 + trail.b.tscore.3 + trail.b.tscore.12 + age.enroll + I(edu) + charlson.score + I(iqcode.score.e) + I(days.hyperdel.imp) + I(days.hypodel.imp) + icudays.sevseptic.s + I(coma.s.imp) + mean.modsofa.icu + mean.benz.cube + mean.op.cube + mean.prop.cube + I(mean.dex.cube) + I(mean.hal.cube)")

set.seed(65)
areg.cog.3 <- aregImpute(areg.formula, data = data.cog.3)
areg.cog.12 <- aregImpute(areg.formula, data = data.cog.12)

```

# RBANS Global Scores (Global Cognition)

We wanted to explore whether durations of the two motoric delirium subtypes were associated with
global cognition among patients who were tested at 3 and 12 months after hospital discharge.

## Model Choice and Covariates
Based on extensive previous analyses using this outcome, we chose a linear regression model for both
time points. All our covariates were either measured at baseline or are summary variables reflecting
the entire ICU stay.

* Primary exposures
    * Days of hyperactive delirium during the hospitalization
    * Days of hypoactive delirium during the hospitalization
    * Interaction between days of hypoactive and hyperactive delirium
* Baseline covariates
    * Age at enrollment
    * Years of education
    * Charlson comorbidity index
    * IQCODE
* ICU/hospitalization covariates
    * Days of severe sepsis
    * Days of coma
    * Mean daily modified SOFA (no CNS component, as this is better reflected by coma and delirium)
    * Mean 24h dose in the ICU of the following medications, all cube root transformed:
        * Benzodiazepines (midazolam equivalents)
        * Opioids (fentanyl equivalents)
        * Propofol
        * Dexmedetomidine
        * Haloperidol
        
All continuous covariates will be allowed to have a nonlinear association with hazard of death,
using restricted cubic splines, if event rates and covariate distribution allows. (For example, there are so many zero doses of haloperidol and dexmedetomidine that it is not feasible to use
splines for these variables.) Degrees of freedom for each covariate will be noted in the model
results table.

```{r model_rbans}
## -- Fit RBANS models -----------------------------------------------------------------------------
## String for righthand side of all cognitive models
cog.independent <- "rcs(age.enroll, 3) + edu + rcs(charlson.score, 3) + iqcode.score.e + rcs(icudays.sevseptic.s, 3) + rcs(coma.s.imp, 3) + rcs(mean.modsofa.icu, 3) + rcs(mean.benz.cube, 3) + rcs(mean.op.cube, 3) + rcs(mean.prop.cube, 3) + mean.dex.cube + mean.hal.cube + rcs(days.hypodel.imp, 3) * days.hyperdel.imp"

## Function to fit linear regression models using fit.mult.impute()
fmi.ols <- function(outcome, df, aregobj){
  modform <- as.formula(paste(outcome, cog.independent, sep = ' ~ '))
  fit.mult.impute(modform, data = df, xtrans = aregobj, fitter = ols, x = TRUE, y = TRUE)
}

## Argument list for RBANS models
rbans.arglist <- list(outcome = c('rbans.global.score.3', 'rbans.global.score.12'),
                      df = list(data.cog.3, data.cog.12),
                      aregobj = list(areg.cog.3, areg.cog.12))

models.rbans <- pmap(rbans.arglist, fmi.ols)

```

## Overall Results
**General summary of motoric subtypes:** A longer duration of hypoactive delirium is significantly associated with worse global cognition scores at both three and twelve months after hospital discharge; this association is nonlinear, so please see `r figure_nums('hypo_rbans', display = 'cite')` for the full effect. Duration of hyperactive delirium is marginally associated with global cognition at three months, but not at twelve months; it is impossible to know if there is a true effect which we can't see due to low amounts of hyperactive delirium, or whether there truly is no association. There is no significant interaction between the two motoric subtypes for this
outcome.

Results for all model covariates, adjusted to the median or mode of all other covariates, are
presented in `r table_nums('results_rbans', display = 'cite')`; due to the presence of
interaction terms, it is important to note that in the table, hypoactive delirium is adjusted to
`r as.character(datadist.cog$limits['Adjust to', 'days.hypodel.imp'])` days and hyperactive delirium
is adjusted to `r as.character(datadist.cog$limits['Adjust to', 'days.hyperdel.imp'])` days. `r figure_nums('hypo_rbans', display = 'cite')` and `r figure_nums('hyper_rbans', display = 'cite')` show the association of each motoric subtype and global cognition, adjusted to various amounts of the other subtype.

*Note on `r table_nums('results_rbans', display = 'cite')`*: For continuous covariates,
differences in scores will be different depending on the points of comparison chosen, especially for
covariates allowed to have a nonlinear relationship with the test score (indicated by df > 1).
We have chosen to compare the 75th percentile and the 25th percentile by default, since this is
often a clinically relevant comparison. For variables with very skewed distributions, where those
two percentiles are the same (eg, lots of zero drug doses), the points of comparison may be the
maximum and minimum instead.

```{r results_rbans}
## -- Get tables of results for RBANS models -------------------------------------------------------
## Combine results tables for each time point
results.rbans <- map(models.rbans, .f = model.results,
                     data.set = data.cog.3, print.format = 'plain', short.labels = lt.shortlabs) %>%
  map(move.stats) %>%
  map(ci.newline) %>%
  map(ital.rows) %>%
  reduce(full_join, by = c('label', 'low', 'high'))

# save(results.rbans, file = 'exampledf.Rdata')

names(results.rbans) <-
  c('Covariate', 'Ref. (usu.\\\n25th %ile)', 'Comp. (usu.\\\n75th %ile)',
    'Difference\\\n(95% CI),\\\n3 months', 'X^2^, 3m', 'df, 3m', 'P, 3m',
    'Difference\\\n(95% CI),\\\n12 months', 'X^2^, 12m', 'df, 12m', 'P, 12m')

```

```{r print_results_rbans, results = 'asis'}
pandoc.table(results.rbans,
             justify = c('left', rep('right', ncol(results.rbans) - 1)),
             split.cells = c(15, rep(Inf, ncol(results.rbans) - 1)),
             split.table = Inf,
             keep.line.breaks = TRUE)

```

```{r plots_rbans}
## Get quantities to adjust each interacting variable to, using all patients with LT outcomes
adjto.probs <- c(0, 0.25, 0.5, 0.75, 0.9)
quants.hypodel.cog <-
  unique(quantile(subset(all.oneobs, id %in% ltpts.either)$days.hypodel.imp, probs = adjto.probs))
quants.hyperdel.cog <-
  unique(quantile(subset(all.oneobs, id %in% ltpts.either)$days.hyperdel.imp, probs = adjto.probs))

## -- Create data set of predicted vals/CIs for each subtype at various levels of the other --------

## Functions to get results where hypoactive, hyperactive delirium is main exposure, adjusted to
## different levels of the other
get.hypo.predict.ols <- function(modobj){
  as.data.frame(Predict(modobj, days.hypodel.imp, days.hyperdel.imp = quants.hyperdel.cog)) %>%
  select(days.hypodel.imp, days.hyperdel.imp, yhat, lower, upper) %>%
  mutate(outcome = modobj$scale.pred,
         main.exposure = 'days.hypodel.imp',
         int.var = 'days.hyperdel.imp',
         xvar = days.hypodel.imp,
         facetvar = days.hyperdel.imp)
}

get.hyper.predict.ols <- function(modobj){
  as.data.frame(Predict(modobj, days.hyperdel.imp, days.hypodel.imp = quants.hypodel.cog)) %>%
  select(days.hypodel.imp, days.hyperdel.imp, yhat, lower, upper) %>%
  mutate(outcome = modobj$scale.pred,
         main.exposure = 'days.hyperdel.imp',
         int.var = 'days.hypodel.imp',
         xvar = days.hyperdel.imp,
         facetvar = days.hypodel.imp)
}

## Function to take a list of data frames and get them into plotting format:
## columns = "Adjusted to days of ______ delirium = ____"
## rows = "__ months"
format.for.cog.plot <- function(df.list){
  df.list %>%
    bind_rows() %>%
    separate(outcome, into = c('test', 'time'), sep = '\\.[t]*score\\.') %>%
    mutate(time.f = factor(time, levels = c(3, 12), labels = c('3 Months', '12 Months')),
           facetvar.f = factor(facetvar,
                               labels = unique(paste(gsub(' of| delirium', '',
                                                          label(data.cog.3[,int.var])),
                                                     facetvar,
                                                     sep = ' = '))))
}

predict.hypo.rbans <- map(models.rbans, get.hypo.predict.ols) %>% format.for.cog.plot()
predict.hyper.rbans <- map(models.rbans, get.hyper.predict.ols) %>% format.for.cog.plot()

hypo.rbans.plot <- ggplot(data = predict.hypo.rbans, aes(x = xvar, y = yhat)) +
  facet_grid(time.f ~ facetvar.f) +
  geom_ribbon(aes(ymin = lower, ymax = upper), fill = nate.navy, alpha = 0.3) +
  geom_line(colour = nate.navy) +
  scale_x_continuous(name = 'Days of hypoactive delirium') +
  scale_y_continuous(name = 'Adjusted RBANS Global Score') # +
  # ggtitle('Days of hypoactive delirium vs global cognition')

hyper.rbans.plot <- ggplot(data = predict.hyper.rbans, aes(x = xvar, y = yhat)) +
  facet_grid(time.f ~ facetvar.f) +
  geom_pointrange(aes(ymin = lower, ymax = upper), size = 0.3, colour = nate.navy) +
  scale_x_continuous(name = 'Days of hyperactive delirium') +
  scale_y_continuous(name = 'Adjusted RBANS Global Score') # +
  # ggtitle('Days of hyperactive delirium vs global cognition')

```

#### `r figure_nums('hypo_rbans')`
```{r hypo_rbans_plot, results = 'asis'}
hypo.rbans.plot

```

#### `r figure_nums('hyper_rbans')`
```{r hyper_rbans_plot, results = 'asis'}
hyper.rbans.plot

```
